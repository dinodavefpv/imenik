<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <title>–ò–º–µ–Ω–Ω–∏–∫ - Proto-Bulgarian Calendar</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#8B4513">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="–ò–º–µ–Ω–Ω–∏–∫">
  <meta name="description" content="Proto-Bulgarian Calendar with dual calendar system and event tracking">
  
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%238B4513'/><text x='50' y='65' text-anchor='middle' font-size='40' fill='white'>‚òÄ</text></svg>">
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Spectral:wght@400;500;600&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
  
  <style>
    /* ===== CSS RESET ===== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 16px; -webkit-font-smoothing: antialiased; }
    body { min-height: 100vh; line-height: 1.5; }
    button { font-family: inherit; cursor: pointer; border: none; background: none; }
    input, textarea, select { font-family: inherit; font-size: inherit; }

    /* ===== CSS VARIABLES ===== */
    :root {
      --font-display: 'Cormorant Garamond', Georgia, serif;
      --font-body: 'Spectral', Georgia, serif;
      --color-bg-primary: #F5EDE0;
      --color-bg-secondary: #EBE1D0;
      --color-bg-tertiary: #E0D5C1;
      --color-bg-card: #FAF6EF;
      --color-text-primary: #2D2419;
      --color-text-secondary: #5C4F3D;
      --color-text-tertiary: #8B7D65;
      --color-text-inverse: #FAF6EF;
      --color-accent-primary: #8B4513;
      --color-accent-secondary: #B8860B;
      --color-border: #C9B896;
      --color-special-eni: #7B2D26;
      --color-special-behti: #2E5A4C;
      --color-error: #9B2335;
      --shadow-sm: 0 1px 2px rgba(45, 36, 25, 0.08);
      --shadow-md: 0 4px 6px rgba(45, 36, 25, 0.1);
      --shadow-lg: 0 10px 15px rgba(45, 36, 25, 0.15);
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 20px;
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;
      --transition-fast: 150ms ease;
      --transition-normal: 250ms ease;
    }

    /* Dark mode */
    [data-mode="dark"] {
      --color-bg-primary: #1A1612;
      --color-bg-secondary: #252018;
      --color-bg-tertiary: #302A20;
      --color-bg-card: #1F1A14;
      --color-text-primary: #E8E0D4;
      --color-text-secondary: #B8A890;
      --color-text-tertiary: #8B7D65;
      --color-text-inverse: #1A1612;
      --color-accent-primary: #CD853F;
      --color-accent-secondary: #DAA520;
      --color-border: #4A3F2F;
      --color-special-eni: #C75050;
      --color-special-behti: #4CAF78;
    }

    /* Modern theme */
    [data-theme="modern"] {
      --font-display: 'Source Sans 3', system-ui, sans-serif;
      --font-body: 'Source Sans 3', system-ui, sans-serif;
      --color-bg-primary: #FFFFFF;
      --color-bg-secondary: #F8F9FA;
      --color-bg-tertiary: #F1F3F4;
      --color-bg-card: #FFFFFF;
      --color-text-primary: #1A1A1A;
      --color-text-secondary: #4A4A4A;
      --color-text-tertiary: #7A7A7A;
      --color-text-inverse: #FFFFFF;
      --color-accent-primary: #2563EB;
      --color-accent-secondary: #3B82F6;
      --color-border: #E5E7EB;
      --color-special-eni: #DC2626;
      --color-special-behti: #059669;
    }

    [data-theme="modern"][data-mode="dark"] {
      --color-bg-primary: #0F0F0F;
      --color-bg-secondary: #1A1A1A;
      --color-bg-tertiary: #262626;
      --color-bg-card: #1A1A1A;
      --color-text-primary: #F5F5F5;
      --color-text-secondary: #A3A3A3;
      --color-text-tertiary: #737373;
      --color-text-inverse: #0F0F0F;
      --color-accent-primary: #3B82F6;
      --color-border: #2A2A2A;
    }

    /* ===== BASE STYLES ===== */
    body {
      font-family: var(--font-body);
      background-color: var(--color-bg-primary);
      color: var(--color-text-primary);
      transition: background-color var(--transition-normal), color var(--transition-normal);
    }

    .app-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* ===== HEADER ===== */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-md);
      background: linear-gradient(to bottom, var(--color-bg-secondary), var(--color-bg-tertiary));
      border-bottom: 2px solid var(--color-border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-title {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
    }

    .header-year {
      font-family: var(--font-display);
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--color-accent-primary);
    }

    .header-animal {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }

    .header-element {
      font-size: 0.75rem;
      color: var(--color-text-tertiary);
    }

    .header-icon {
      width: 32px;
      height: 32px;
      margin-right: var(--space-sm);
    }

    .nav-button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      border-radius: var(--radius-md);
      color: var(--color-text-secondary);
      font-size: 1.5rem;
      transition: all var(--transition-fast);
    }

    .nav-button:hover {
      background-color: var(--color-bg-tertiary);
      color: var(--color-text-primary);
    }

    /* ===== MAIN CONTENT ===== */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: var(--space-md);
      padding-bottom: calc(var(--space-xl) + 70px);
    }

    /* ===== VIEW SWITCHER ===== */
    .view-switcher {
      display: flex;
      gap: var(--space-xs);
      padding: var(--space-sm);
      background-color: var(--color-bg-secondary);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-md);
    }

    .view-switch-btn {
      flex: 1;
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-secondary);
      transition: all var(--transition-fast);
    }

    .view-switch-btn.active {
      background-color: var(--color-accent-primary);
      color: var(--color-text-inverse);
    }

    .view-switch-btn:not(.active):hover {
      background-color: var(--color-bg-tertiary);
    }

    /* ===== QUICK ADD ===== */
    .quick-add-bar {
      display: flex;
      gap: var(--space-sm);
      padding: var(--space-sm);
      background-color: var(--color-bg-card);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-md);
      border: 1px solid var(--color-border);
    }

    .quick-add-input {
      flex: 1;
      padding: var(--space-sm) var(--space-md);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background-color: var(--color-bg-primary);
      color: var(--color-text-primary);
      font-size: 0.875rem;
    }

    .quick-add-input:focus {
      outline: none;
      border-color: var(--color-accent-primary);
    }

    /* ===== CALENDAR ===== */
    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-md);
    }

    .calendar-month-title {
      font-family: var(--font-display);
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .weekday-header {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      margin-bottom: var(--space-xs);
    }

    .weekday-cell {
      text-align: center;
      padding: var(--space-sm);
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--color-text-tertiary);
      text-transform: uppercase;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--space-xs);
      background-color: var(--color-bg-card);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
      position: relative;
      font-family: var(--font-display);
      font-weight: 600;
      font-size: 1.125rem;
    }

    .calendar-day:hover { background-color: var(--color-bg-tertiary); }
    .calendar-day.today { background-color: var(--color-accent-primary); color: var(--color-text-inverse); }
    .calendar-day.selected { outline: 2px solid var(--color-accent-primary); outline-offset: -2px; }
    .calendar-day.empty { background: transparent; cursor: default; }
    .calendar-day.eni { background: linear-gradient(135deg, var(--color-special-eni), #a33); color: var(--color-text-inverse); }
    .calendar-day.behti { background: linear-gradient(135deg, var(--color-special-behti), #3a8); color: var(--color-text-inverse); }

    .day-gregorian {
      font-size: 0.65rem;
      opacity: 0.7;
      font-weight: 400;
      margin-top: 2px;
    }

    .event-dot {
      position: absolute;
      bottom: 4px;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background-color: var(--color-accent-secondary);
    }

    .holiday-dot {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }
    .holiday-dot.solar { background-color: #F59E0B; box-shadow: 0 0 4px #F59E0B; }
    .holiday-dot.national { background-color: var(--color-text-primary); }
    .holiday-dot.tradition { background-color: #DC2626; }

    .holiday-text.solar { color: #F59E0B; }
    .holiday-text.national { color: var(--color-text-primary); }
    .holiday-text.tradition { color: #DC2626; }
    .holiday-name { font-size: 0.75rem; margin-top: 2px; font-weight: 500; }
    
    .mini-day.solar { color: #F59E0B; font-weight: 700; }
    .mini-day.national { color: var(--color-text-primary); font-weight: 700; text-decoration: underline; }
    .mini-day.tradition { color: #DC2626; font-weight: 700; }

    /* ===== YEAR VIEW ===== */
    .year-view {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-md);
    }

    @media (max-width: 480px) {
      .year-view { grid-template-columns: repeat(2, 1fr); }
    }

    .year-month-card {
      background-color: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
      border: 1px solid var(--color-border);
    }

    .year-month-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .year-month-card.current { border-color: var(--color-accent-primary); border-width: 2px; }

    .year-month-title {
      font-family: var(--font-display);
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: var(--space-xs);
    }

    .year-month-mini-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      font-size: 0.5rem;
    }

    .mini-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-tertiary);
    }

    .mini-day.today {
      background-color: var(--color-accent-primary);
      color: var(--color-text-inverse);
      border-radius: 50%;
    }

    /* ===== WEEK VIEW ===== */
    .week-view { display: flex; flex-direction: column; gap: var(--space-sm); }

    .week-day-row {
      display: flex;
      gap: var(--space-md);
      padding: var(--space-md);
      background-color: var(--color-bg-card);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
      border: 1px solid var(--color-border);
    }

    .week-day-row:hover { background-color: var(--color-bg-tertiary); }
    .week-day-row.today { border-left: 4px solid var(--color-accent-primary); }

    .week-day-date {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 50px;
    }

    .week-day-name {
      font-size: 0.75rem;
      color: var(--color-text-tertiary);
      text-transform: uppercase;
    }

    .week-day-number {
      font-family: var(--font-display);
      font-size: 1.5rem;
      font-weight: 600;
    }

    .week-day-events { flex: 1; }

    /* ===== DAY VIEW ===== */
    .day-view { display: flex; flex-direction: column; gap: var(--space-md); }

    .day-header {
      text-align: center;
      padding: var(--space-lg);
      background-color: var(--color-bg-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-border);
    }

    .day-header-date {
      font-family: var(--font-display);
      font-size: 3rem;
      font-weight: 700;
      color: var(--color-accent-primary);
    }

    .day-header-month { font-size: 1.25rem; color: var(--color-text-secondary); }
    .day-header-gregorian { font-size: 0.875rem; color: var(--color-text-tertiary); margin-top: var(--space-xs); }

    /* ===== EVENTS ===== */
    .event-card {
      display: flex;
      align-items: flex-start;
      gap: var(--space-md);
      padding: var(--space-md);
      background-color: var(--color-bg-card);
      border-radius: var(--radius-md);
      border-left: 4px solid var(--color-accent-secondary);
      cursor: pointer;
      transition: all var(--transition-fast);
      margin-bottom: var(--space-sm);
    }

    .event-card:hover { background-color: var(--color-bg-tertiary); }
    .event-title { font-weight: 500; }
    .event-time { font-size: 0.875rem; color: var(--color-text-tertiary); min-width: 50px; }
    .event-description { font-size: 0.875rem; color: var(--color-text-secondary); }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--space-xl);
      color: var(--color-text-tertiary);
      font-size: 0.875rem;
    }

    /* ===== BOTTOM NAV ===== */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: var(--space-sm) var(--space-md);
      padding-bottom: calc(var(--space-sm) + env(safe-area-inset-bottom, 0px));
      background: linear-gradient(to top, var(--color-bg-secondary), var(--color-bg-tertiary));
      border-top: 2px solid var(--color-border);
      z-index: 100;
    }

    .bottom-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      padding: var(--space-xs) var(--space-sm);
      border-radius: var(--radius-md);
      color: var(--color-text-tertiary);
      font-size: 0.625rem;
      text-transform: uppercase;
      transition: all var(--transition-fast);
    }

    .bottom-nav-item.active { color: var(--color-accent-primary); }
    .bottom-nav-item:hover { color: var(--color-text-primary); background-color: var(--color-bg-tertiary); }
    .bottom-nav-item span.icon { font-size: 1.5rem; }

    /* ===== MODALS ===== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 150ms ease;
    }

    .modal-overlay.hidden { display: none; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    .modal-content {
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      background-color: var(--color-bg-primary);
      border-radius: var(--radius-xl) var(--radius-xl) 0 0;
      overflow: hidden;
      animation: slideUp 250ms ease;
    }

    @media (min-width: 768px) {
      .modal-overlay { align-items: center; }
      .modal-content { border-radius: var(--radius-xl); max-height: 80vh; }
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-md);
      border-bottom: 1px solid var(--color-border);
    }

    .modal-title {
      font-family: var(--font-display);
      font-size: 1.25rem;
      font-weight: 600;
    }

    .modal-body {
      padding: var(--space-md);
      overflow-y: auto;
      max-height: calc(90vh - 140px);
    }

    .modal-footer {
      display: flex;
      gap: var(--space-sm);
      padding: var(--space-md);
      border-top: 1px solid var(--color-border);
    }

    /* ===== FORM ===== */
    .form-group { margin-bottom: var(--space-md); }

    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-xs);
    }

    .form-input, .form-textarea, .form-select {
      width: 100%;
      padding: var(--space-sm) var(--space-md);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background-color: var(--color-bg-card);
      color: var(--color-text-primary);
      font-size: 1rem;
    }

    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: var(--color-accent-primary);
    }

    .form-textarea { min-height: 80px; resize: vertical; }
    .form-row { display: flex; gap: var(--space-sm); }
    .form-row > * { flex: 1; }

    /* ===== BUTTONS ===== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-md);
      font-weight: 500;
      font-size: 0.875rem;
      transition: all var(--transition-fast);
      flex: 1;
    }

    .btn-primary { background-color: var(--color-accent-primary); color: var(--color-text-inverse); }
    .btn-primary:hover { opacity: 0.9; }
    .btn-secondary { background-color: var(--color-bg-tertiary); color: var(--color-text-primary); }
    .btn-secondary:hover { background-color: var(--color-border); }
    .btn-danger { background-color: var(--color-error); color: white; }
    .btn-icon { padding: var(--space-sm); flex: 0; }

    /* ===== SETTINGS ===== */
    .settings-section { margin-bottom: var(--space-xl); }

    .settings-section-title {
      font-family: var(--font-display);
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--color-text-tertiary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: var(--space-md);
    }

    .settings-option {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: var(--space-md);
      background-color: var(--color-bg-card);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-xs);
      border: 1px solid var(--color-border);
      gap: var(--space-sm);
    }

    .settings-option-header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .settings-option-title { font-weight: 500; }
    
    .segmented-control {
      display: flex;
      background-color: var(--color-bg-tertiary);
      border-radius: var(--radius-md);
      padding: 4px;
      width: 100%;
    }

    .segmented-option {
      flex: 1;
      padding: 6px 12px;
      text-align: center;
      border-radius: calc(var(--radius-md) - 2px);
      font-size: 0.875rem;
      color: var(--color-text-secondary);
      transition: all var(--transition-fast);
      cursor: pointer;
    }

    .segmented-option.active {
      background-color: var(--color-bg-card);
      color: var(--color-text-primary);
      box-shadow: var(--shadow-sm);
      font-weight: 500;
    }

    /* ===== TUTORIAL ===== */
    .tutorial-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--color-bg-primary);
      z-index: 2000;
      display: flex;
      flex-direction: column;
    }

    .tutorial-overlay.hidden { display: none; }

    .tutorial-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--space-xl);
      text-align: center;
    }

    .tutorial-icon { font-size: 5rem; margin-bottom: var(--space-xl); }

    .tutorial-title {
      font-family: var(--font-display);
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: var(--space-md);
      color: var(--color-accent-primary);
    }

    .tutorial-description {
      font-size: 1rem;
      color: var(--color-text-secondary);
      max-width: 320px;
      line-height: 1.6;
    }

    .tutorial-dots {
      display: flex;
      gap: var(--space-sm);
      margin: var(--space-xl) 0;
    }

    .tutorial-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: var(--color-border);
      transition: all var(--transition-fast);
    }

    .tutorial-dot.active {
      width: 24px;
      border-radius: 4px;
      background-color: var(--color-accent-primary);
    }

    .tutorial-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-md) var(--space-xl);
      padding-bottom: calc(var(--space-md) + env(safe-area-inset-bottom, 0px));
    }

    .tutorial-footer .btn {
      flex: 0 0 auto;
      min-width: 120px;
    }

    .tutorial-skip { color: var(--color-text-tertiary); font-size: 0.875rem; }

    /* ===== LOADING ===== */
    .loading { display: flex; align-items: center; justify-content: center; padding: var(--space-xl); }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--color-border);
      border-top-color: var(--color-accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Hide pages */
    .page { display: none; }
    .page.active { display: block; }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Tutorial Overlay -->
    <div id="tutorial" class="tutorial-overlay hidden">
      <div class="tutorial-content">
        <div class="tutorial-icon" id="tutorial-icon">üìú</div>
        <h1 class="tutorial-title" id="tutorial-title" data-i18n="tutorial.welcome">–î–æ–±—Ä–µ –¥–æ—à–ª–∏ –≤ –ò–º–µ–Ω–Ω–∏–∫</h1>
        <p class="tutorial-description" id="tutorial-desc" data-i18n="tutorial.welcomeDesc">–û—Ç–∫—Ä–∏–π—Ç–µ –¥—Ä–µ–≤–Ω–∏—è –ø—Ä–∞–±—ä–ª–≥–∞—Ä—Å–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä - –µ–¥–Ω–∞ –æ—Ç –Ω–∞–π-—Ç–æ—á–Ω–∏—Ç–µ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–∏ —Å–∏—Å—Ç–µ–º–∏ –≤ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞.</p>
        <div class="tutorial-dots" id="tutorial-dots"></div>
      </div>
      <div class="tutorial-footer">
        <button class="tutorial-skip" id="tutorial-skip" data-i18n="tutorial.skip">–ü—Ä–æ–ø—É—Å–Ω–∏</button>
        <button class="btn btn-primary" id="tutorial-next" data-i18n="tutorial.next">–ù–∞–ø—Ä–µ–¥</button>
      </div>
    </div>

    <!-- Header -->
    <header class="header">
      <img src="icons/icon-192x192.png" class="header-icon" alt="Logo">
      <div class="header-title">
        <div class="header-year" id="header-year">–ì–æ–¥–∏–Ω–∞ –Ω–∞ –ó–º–∏—è—Ç–∞ 7531</div>
        <div class="header-element" id="header-element">–î—ä—Ä–≤–æ ‚Ä¢ –ñ–µ–Ω—Å–∫–∏</div>
      </div>
      <div id="header-animal" style="font-size: 1.75rem;">üêç</div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Calendar Page -->
      <div id="page-calendar" class="page active">
        <div class="view-switcher">
          <button class="view-switch-btn active" data-view="month" data-i18n="view.month">–ú–µ—Å–µ—Ü</button>
          <button class="view-switch-btn" data-view="week" data-i18n="view.week">–°–µ–¥–º–∏—Ü–∞</button>
          <button class="view-switch-btn" data-view="day" data-i18n="view.day">–î–µ–Ω</button>
          <button class="view-switch-btn" data-view="year" data-i18n="view.year">–ì–æ–¥–∏–Ω–∞</button>
        </div>

        <!-- Month View -->
        <div id="view-month" class="view">
          <div class="calendar-header">
            <button class="nav-button" id="prev-month">‚óÄ</button>
            <h2 class="calendar-month-title" id="month-title">–ê–õ–ï–ú 7531</h2>
            <button class="nav-button" id="next-month">‚ñ∂</button>
          </div>
          <div class="weekday-header" id="weekday-header"></div>
          <div class="calendar-grid" id="calendar-grid"></div>
        </div>

        <!-- Week View -->
        <div id="view-week" class="view" style="display:none;">
          <div class="calendar-header">
            <button class="nav-button" id="prev-week">‚óÄ</button>
            <h2 class="calendar-month-title" id="week-title" data-i18n="view.week">–°–µ–¥–º–∏—Ü–∞</h2>
            <button class="nav-button" id="next-week">‚ñ∂</button>
          </div>
          <div class="week-view" id="week-grid"></div>
        </div>

        <!-- Day View -->
        <div id="view-day" class="view" style="display:none;">
          <div class="calendar-header">
            <button class="nav-button" id="prev-day">‚óÄ</button>
            <span style="flex:1"></span>
            <button class="nav-button" id="next-day">‚ñ∂</button>
          </div>
          <div class="day-view">
            <div class="day-header">
              <div class="day-header-date" id="day-date">15</div>
              <div class="day-header-month" id="day-month">–ê–õ–ï–ú</div>
              <div class="day-header-gregorian" id="day-gregorian">22/12/2024</div>
            </div>
            <div id="day-events"></div>
          </div>
        </div>

        <!-- Year View -->
        <div id="view-year" class="view" style="display:none;">
          <div class="calendar-header">
            <button class="nav-button" id="prev-year">‚óÄ</button>
            <h2 class="calendar-month-title" id="year-title">7531</h2>
            <button class="nav-button" id="next-year">‚ñ∂</button>
          </div>
          <div class="year-view" id="year-grid"></div>
        </div>
      </div>

      <!-- Settings Page -->
      <div id="page-settings" class="page">
        <div class="settings-section">
          <h3 class="settings-section-title" data-i18n="settings.appearance">–ò–∑–≥–ª–µ–¥</h3>
          <div class="settings-option">
            <div class="settings-option-header">
              <div class="settings-option-title" data-i18n="settings.theme">–¢–µ–º–∞</div>
            </div>
            <div class="segmented-control">
              <div class="segmented-option" id="opt-theme-traditional" data-value="traditional" data-i18n="settings.traditional">–¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∞</div>
              <div class="segmented-option" id="opt-theme-modern" data-value="modern" data-i18n="settings.modern">–ú–æ–¥–µ—Ä–Ω–∞</div>
            </div>
          </div>
          <div class="settings-option">
            <div class="settings-option-header">
              <div class="settings-option-title" data-i18n="settings.mode">–†–µ–∂–∏–º</div>
            </div>
            <div class="segmented-control">
              <div class="segmented-option" id="opt-mode-light" data-value="light" data-i18n="settings.light">–°–≤–µ—Ç—ä–ª</div>
              <div class="segmented-option" id="opt-mode-dark" data-value="dark" data-i18n="settings.dark">–¢—ä–º–µ–Ω</div>
            </div>
          </div>
        </div>
        <div class="settings-section">
          <h3 class="settings-section-title" data-i18n="settings.language">–ï–∑–∏–∫</h3>
          <div class="settings-option">
            <div class="settings-option-header">
              <div class="settings-option-title" data-i18n="settings.lang">–ï–∑–∏–∫</div>
            </div>
            <div class="segmented-control">
              <div class="segmented-option" id="opt-lang-bg" data-value="bg" data-i18n="settings.bg">–ë—ä–ª–≥–∞—Ä—Å–∫–∏</div>
              <div class="segmented-option" id="opt-lang-en" data-value="en" data-i18n="settings.en">English</div>
            </div>
          </div>
          <div class="settings-option">
            <div class="settings-option-header">
              <div class="settings-option-title" data-i18n="settings.terms">–¢–µ—Ä–º–∏–Ω–∏</div>
            </div>
            <div class="segmented-control">
              <div class="segmented-option" id="opt-terms-proto" data-value="proto" data-i18n="settings.proto">–ü—Ä–∞–±—ä–ª–≥–∞—Ä—Å–∫–∏</div>
              <div class="segmented-option" id="opt-terms-modern" data-value="modern" data-i18n="settings.modernTerms">–°—ä–≤—Ä–µ–º–µ–Ω–Ω–∏</div>
            </div>
          </div>
        </div>
        <div class="settings-section">
          <h3 class="settings-section-title" data-i18n="settings.calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä</h3>
          <div class="settings-option">
            <div class="settings-option-header">
              <div class="settings-option-title" data-i18n="settings.weekStart">–ù–∞—á–∞–ª–æ –Ω–∞ —Å–µ–¥–º–∏—Ü–∞—Ç–∞</div>
            </div>
            <div class="segmented-control">
              <div class="segmented-option" id="opt-week-mon" data-value="1" data-i18n="settings.monday">–ü–æ–Ω–µ–¥–µ–ª–Ω–∏–∫</div>
              <div class="segmented-option" id="opt-week-sun" data-value="0" data-i18n="settings.sunday">–ù–µ–¥–µ–ª—è</div>
            </div>
          </div>
          <div class="settings-option">
            <div class="settings-option-header">
              <div class="settings-option-title" data-i18n="settings.showGregorian">–ü–æ–∫–∞–∑–≤–∞–π –≥—Ä–∏–≥–æ—Ä–∏–∞–Ω—Å–∫–∏</div>
            </div>
            <div class="segmented-control">
              <div class="segmented-option" id="opt-greg-on" data-value="true" data-i18n="settings.yes">–î–∞</div>
              <div class="segmented-option" id="opt-greg-off" data-value="false" data-i18n="settings.no">–ù–µ</div>
            </div>
          </div>
        </div>
        <div class="settings-section">
          <h3 class="settings-section-title" data-i18n="settings.data">–î–∞–Ω–Ω–∏</h3>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-secondary" id="export-btn" data-i18n="btn.export">üì• –ï–∫—Å–ø–æ—Ä—Ç ICS</button>
            <button class="btn btn-secondary" id="import-btn" data-i18n="btn.import">üì§ –ò–º–ø–æ—Ä—Ç ICS</button>
          </div>
          <input type="file" id="import-file" accept=".ics" style="display:none">
        </div>
        <div class="settings-section">
          <button class="btn btn-secondary" id="tutorial-btn" style="width:100%" data-i18n="btn.tutorial">üìñ –ü–æ–≤—Ç–æ—Ä–∏ —É—Ä–æ–∫–∞</button>
        </div>
      </div>
    </main>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
      <button class="bottom-nav-item" id="add-event-btn">
        <span class="icon">+</span>
        <span data-i18n="nav.add">–î–æ–±–∞–≤–∏</span>
      </button>
      <button class="bottom-nav-item active" id="today-btn">
        <span class="icon">‚äô</span>
        <span data-i18n="nav.today">–î–Ω–µ—Å</span>
      </button>
      <button class="bottom-nav-item" data-page="settings">
        <span class="icon">‚öô</span>
        <span data-i18n="nav.settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
      </button>
    </nav>

    <!-- Event Modal -->
    <div class="modal-overlay hidden" id="event-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="modal-title" data-i18n="modal.addEvent">–î–æ–±–∞–≤–∏ —Å—ä–±–∏—Ç–∏–µ</h2>
          <button class="nav-button" id="modal-close">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label" data-i18n="modal.title">–ó–∞–≥–ª–∞–≤–∏–µ</label>
            <input type="text" class="form-input" id="event-title" placeholder="–ó–∞–≥–ª–∞–≤–∏–µ –Ω–∞ —Å—ä–±–∏—Ç–∏–µ—Ç–æ">
          </div>
          <div class="form-group">
            <label class="form-label" data-i18n="modal.desc">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea class="form-textarea" id="event-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label" data-i18n="modal.date">–î–∞—Ç–∞</label>
            <div class="form-row">
              <select class="form-select" id="event-year"></select>
              <select class="form-select" id="event-month"></select>
              <select class="form-select" id="event-day"></select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" data-i18n="modal.time">–ß–∞—Å (–ø–æ –∏–∑–±–æ—Ä)</label>
            <div class="form-row">
              <select class="form-select" id="event-hour">
                <option value="">--</option>
              </select>
              <select class="form-select" id="event-minute">
                <option value="">--</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" data-i18n="modal.recurrence">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</label>
            <select class="form-select" id="event-recurrence">
              <option value="none" data-i18n="rec.none">–ù—è–º–∞</option>
              <option value="daily" data-i18n="rec.daily">–î–Ω–µ–≤–Ω–æ</option>
              <option value="weekly" data-i18n="rec.weekly">–°–µ–¥–º–∏—á–Ω–æ</option>
              <option value="monthly" data-i18n="rec.monthly">–ú–µ—Å–µ—á–Ω–æ</option>
              <option value="yearly" data-i18n="rec.yearly">–ì–æ–¥–∏—à–Ω–æ</option>
              <option value="animal" data-i18n="rec.animal">–ù–∞ 12 –≥–æ–¥–∏–Ω–∏ (–∂–∏–≤–æ—Ç–∏–Ω—Å–∫–∏ —Ü–∏–∫—ä–ª)</option>
              <option value="starday" data-i18n="rec.starday">–ù–∞ 60 –≥–æ–¥–∏–Ω–∏ (–∑–≤–µ–∑–¥–µ–Ω –¥–µ–Ω)</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger btn-icon" id="event-delete" style="display:none">üóë</button>
          <button class="btn btn-secondary" id="event-cancel" data-i18n="btn.cancel">–û—Ç–∫–∞–∑</button>
          <button class="btn btn-primary" id="event-save" data-i18n="btn.save">–ó–∞–ø–∞–∑–∏</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== PROTO-BULGARIAN CALENDAR ENGINE =====
    // Epoch: 5505 BC (counting back). 
    // Current year calculation: (Gregorian Year + 5505).
    // Note: The calendar starts on Winter Solstice. 
    // The PB year effectively covers the *following* Gregorian year.
    // e.g., Dec 2024 starts PB year 7530 (which corresponds to 2025).
    const EPOCH_OFFSET = 5505; 
    
    const ANIMALS = [
      { id: 0, proto: '–î–û–ö–°', protoEn: 'DOKS', bg: '–ü—Ä–∞—Å–µ', en: 'Pig', emoji: 'üê∑', color: '#C4A4A4' },
      { id: 1, proto: '–°–û–ú–û–†', protoEn: 'SOMOR', bg: '–ú–∏—à–∫–∞', en: 'Mouse', emoji: 'üê≠', color: '#A8A8B8' },
      { id: 2, proto: '–®–ï–ì–û–†', protoEn: 'SHEGOR', bg: '–í–æ–ª', en: 'Bull', emoji: 'üêÇ', color: '#8B6914' },
      { id: 3, proto: '–ë–ê–†–°', protoEn: 'BARS', bg: '–ë–∞—Ä—Å', en: 'Tiger', emoji: 'üêØ', color: '#D4842A' },
      { id: 4, proto: '–î–í–ê–ù', protoEn: 'DVAN', bg: '–ó–∞–µ–∫', en: 'Rabbit', emoji: 'üê∞', color: '#E8DCC8' },
      { id: 5, proto: '–í–ï–†–ï–ù–ò', protoEn: 'VERENI', bg: '–î—Ä–∞–∫–æ–Ω', en: 'Dragon', emoji: 'üêâ', color: '#2E8B57' },
      { id: 6, proto: '–î–ò–õ–û–ú', protoEn: 'DILOM', bg: '–ó–º–∏—è', en: 'Snake', emoji: 'üêç', color: '#6B3FA0' },
      { id: 7, proto: '–¢–ï–ö–£', protoEn: 'TEKU', bg: '–ö–æ–Ω', en: 'Horse', emoji: 'üê¥', color: '#8B4513' },
      { id: 8, proto: '–ü–ò–°–ò–ù', protoEn: 'PISIN', bg: '–ú–∞–π–º—É–Ω–∞', en: 'Monkey', emoji: 'üêµ', color: '#DAA520' },
      { id: 9, proto: '–°–£–†–ê–•', protoEn: 'SURAH', bg: '–û–≤–µ–Ω', en: 'Ram', emoji: 'üêè', color: '#FFFFF0' },
      { id: 10, proto: '–¢–û–•', protoEn: 'TOH', bg: '–ü–µ—Ç–µ–ª', en: 'Rooster', emoji: 'üêì', color: '#DC143C' },
      { id: 11, proto: '–ï–¢–•', protoEn: 'ETH', bg: '–ö—É—á–µ', en: 'Dog', emoji: 'üêï', color: '#C4A484' },
    ];

    const ELEMENTS = [
      { id: 0, proto: '–í–û–î–ê', protoEn: 'VODA', bg: '–í–æ–¥–∞', en: 'Water', color: '#4A90D9', colorDark: '#6BA4E4' },
      { id: 1, proto: '–û–ì–™–ù', protoEn: 'OGAN', bg: '–û–≥—ä–Ω', en: 'Fire', color: '#E85D04', colorDark: '#FF7F24' },
      { id: 2, proto: '–ó–ï–ú–Ø', protoEn: 'ZEMYA', bg: '–ó–µ–º—è', en: 'Earth', color: '#8B7355', colorDark: '#D4C2AA' },
      { id: 3, proto: '–î–™–†–í–û', protoEn: 'DARVO', bg: '–î—ä—Ä–≤–æ', en: 'Tree', color: '#228B22', colorDark: '#4ADE80' },
      { id: 4, proto: '–ú–ï–¢–ê–õ', protoEn: 'METAL', bg: '–ú–µ—Ç–∞–ª', en: 'Metal', color: '#71797E', colorDark: '#A0AEC0' },
    ];

    const GENDERS = [
      { proto: '–ú–™–ñ–ö–ò', protoEn: 'MAZHKI', bg: '–ú—ä–∂–∫–∏', en: 'Male' },
      { proto: '–ñ–ï–ù–°–ö–ò', protoEn: 'ZHENSKI', bg: '–ñ–µ–Ω—Å–∫–∏', en: 'Female' },
    ];

    const MONTHS = [
      { id: 1, proto: '–ê–õ–ï–ú', protoEn: 'ALEM', bg: '–ü—ä—Ä–≤–∏', en: 'First', days: 31 },
      { id: 2, proto: '–¢–£–¢–û–ú', protoEn: 'TUTOM', bg: '–í—Ç–æ—Ä–∏', en: 'Second', days: 30 },
      { id: 3, proto: '–ß–ò–¢–ï–ú', protoEn: 'CHITEM', bg: '–¢—Ä–µ—Ç–∏', en: 'Third', days: 30 },
      { id: 4, proto: '–¢–í–ò–†–ï–ú', protoEn: 'TVIREM', bg: '–ß–µ—Ç–≤—ä—Ä—Ç–∏', en: 'Fourth', days: 31 },
      { id: 5, proto: '–í–ï–ß–ï–ú', protoEn: 'VECHEM', bg: '–ü–µ—Ç–∏', en: 'Fifth', days: 30 },
      { id: 6, proto: '–®–ï–•–¢–ï–ú', protoEn: 'SHEHTEM', bg: '–®–µ—Å—Ç–∏', en: 'Sixth', days: 30 },
      { id: 7, proto: '–°–ï–¢–ï–ú', protoEn: 'SETEM', bg: '–°–µ–¥–º–∏', en: 'Seventh', days: 31 },
      { id: 8, proto: '–û–°–ï–ú', protoEn: 'OSEM', bg: '–û—Å–º–∏', en: 'Eighth', days: 30 },
      { id: 9, proto: '–î–ï–í–ï–ú', protoEn: 'DEVEM', bg: '–î–µ–≤–µ—Ç–∏', en: 'Ninth', days: 30 },
      { id: 10, proto: '–ï–õ–ï–ú', protoEn: 'ELEM', bg: '–î–µ—Å–µ—Ç–∏', en: 'Tenth', days: 31 },
      { id: 11, proto: '–ï–ù–ò–ê–õ–ï–ú', protoEn: 'ENIALEM', bg: '–ï–¥–∏–Ω–∞–¥–µ—Å–µ—Ç–∏', en: 'Eleventh', days: 30 },
      { id: 12, proto: '–ê–õ–¢–ï–ú', protoEn: 'ALTEM', bg: '–î–≤–∞–Ω–∞–¥–µ—Å–µ—Ç–∏', en: 'Twelfth', days: 30 },
    ];

    // Special definitions for Eni and Behti for display purposes
    const DAY_ENI = { id: 0, proto: '–ï–ù–ò', protoEn: 'ENI', bg: '–ï–Ω–∏ (–ò–≥–Ω–∞–∂–¥–µ–Ω)', en: 'Eni (Ignazhden)', days: 1, isSpecial: true };
    const DAY_BEHTI = { id: 13, proto: '–ë–ï–•–¢–ò', protoEn: 'BEHTI', bg: '–ë–µ—Ö—Ç–∏', en: 'Behti', days: 1, isSpecial: true };

    const WEEKDAYS = [
      { proto: '–ù–ï–î', bg: '–ù–¥', en: 'Su' },
      { proto: '–ü–û–ù', bg: '–ü–Ω', en: 'Mo' },
      { proto: '–í–¢–û', bg: '–í—Ç', en: 'Tu' },
      { proto: '–°–†–Ø', bg: '–°—Ä', en: 'We' },
      { proto: '–ß–ï–¢', bg: '–ß—Ç', en: 'Th' },
      { proto: '–ü–ï–¢', bg: '–ü—Ç', en: 'Fr' },
      { proto: '–°–™–ë', bg: '–°–±', en: 'Sa' },
    ];

    const TUTORIAL_SLIDES = [
      { icon: 'üìú', title: '–î–æ–±—Ä–µ –¥–æ—à–ª–∏ –≤ –ò–º–µ–Ω–Ω–∏–∫', desc: '–û—Ç–∫—Ä–∏–π—Ç–µ –¥—Ä–µ–≤–Ω–∏—è –ø—Ä–∞–±—ä–ª–≥–∞—Ä—Å–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä - –µ–¥–Ω–∞ –æ—Ç –Ω–∞–π-—Ç–æ—á–Ω–∏—Ç–µ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–∏ —Å–∏—Å—Ç–µ–º–∏ –≤ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞.' },
      { icon: 'üêâ', title: '12-–≥–æ–¥–∏—à–µ–Ω —Ü–∏–∫—ä–ª', desc: '–í—Å—è–∫–∞ –≥–æ–¥–∏–Ω–∞ –µ –Ω–∞—Ä–µ—á–µ–Ω–∞ –Ω–∞ –µ–¥–Ω–æ –æ—Ç 12 –∂–∏–≤–æ—Ç–Ω–∏: –ü—Ä–∞—Å–µ, –ú–∏—à–∫–∞, –í–æ–ª, –ë–∞—Ä—Å, –ó–∞–µ–∫, –î—Ä–∞–∫–æ–Ω, –ó–º–∏—è, –ö–æ–Ω, –ú–∞–π–º—É–Ω–∞, –û–≤–µ–Ω, –ü–µ—Ç–µ–ª, –ö—É—á–µ.' },
      { icon: '‚ú®', title: '60-–≥–æ–¥–∏—à–µ–Ω –ó–≤–µ–∑–¥–µ–Ω –¥–µ–Ω', desc: '–ü–µ—Ç —Å—Ç–∏—Ö–∏–∏ —Å–µ —Ä–µ–¥—É–≤–∞—Ç: –í–æ–¥–∞, –û–≥—ä–Ω, –ó–µ–º—è, –î—ä—Ä–≤–æ, –ú–µ—Ç–∞–ª. –í—Å—è–∫–∞ —Å—Ç–∏—Ö–∏—è —É–ø—Ä–∞–≤–ª—è–≤–∞ 12 –≥–æ–¥–∏–Ω–∏.' },
      { icon: '‚òÄÔ∏è', title: '–ï–Ω–∏ - –ù–æ–≤–∞ –ì–æ–¥–∏–Ω–∞', desc: '–ù–æ–≤–∞—Ç–∞ –≥–æ–¥–∏–Ω–∞ –∑–∞–ø–æ—á–≤–∞ –Ω–∞ –∑–∏–º–Ω–æ—Ç–æ —Å–ª—ä–Ω—Ü–µ—Å—Ç–æ–µ–Ω–µ (~21-22 –¥–µ–∫–µ–º–≤—Ä–∏). –¢–æ–∑–∏ –¥–µ–Ω —Å–µ –Ω–∞—Ä–∏—á–∞ –ï–Ω–∏ –∏ –Ω–µ –µ —á–∞—Å—Ç –æ—Ç –º–µ—Å–µ—Ü–∏—Ç–µ.' },
    ];

    // ===== STATE =====
    let state = {
      settings: {
        theme: 'traditional',
        mode: 'dark',
        lang: 'bg',
        useProto: true,
        weekStartsOn: 1,
        showGregorian: false,
        tutorialDone: false,
      },
      selectedDate: null,
      currentView: 'month',
      currentPage: 'calendar',
      events: [],
      editingEvent: null,
      tutorialSlide: 0,
    };

    // ===== CALENDAR FUNCTIONS =====
    
    // Check if a Gregorian year is a leap year
    function isLeapGregorian(year) {
      return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
    }

    // Check if PB year is leap. 
    // A PB year covers Jan-Dec of the *following* Gregorian year.
    // So if the following Gregorian year is leap, the PB year needs a leap day (Behti).
    function isPBYearLeap(pbYear) {
      // pbYear 7530 -> Gregorian 2025.
      // 7530 - 5505 = 2025.
      const gregYear = pbYear - EPOCH_OFFSET; 
      return isLeapGregorian(gregYear);
    }

    function getWinterSolstice(gYear) {
      // Simplified: Always Dec 21 for calculation base, 
      // though astronomically it varies. Standard PB calendar uses fixed point or simple rule.
      // Usually Eni is Dec 22 if previous year was leap? 
      // For this implementation, we anchor to Dec 21 as the START of Eni/Year.
      return new Date(gYear, 11, 21);
    }

    function getAnimalForYear(pbYear) {
      const asparuhYear = 6186;
      const asparuhAnimalIndex = 5;
      const yearDiff = pbYear - asparuhYear;
      const idx = ((yearDiff % 12) + 12 + asparuhAnimalIndex) % 12;
      return ANIMALS[idx];
    }

    function getElementForYear(pbYear) {
      const cyclePosition = ((pbYear - 1) % 60 + 60) % 60;
      return ELEMENTS[Math.floor(cyclePosition / 12)];
    }

    function getGenderForYear(pbYear) {
      const el = getElementForYear(pbYear);
      return el.id % 2 === 0 ? GENDERS[0] : GENDERS[1];
    }

    function gregorianToPB(date) {
      const d = new Date(date);
      d.setHours(0,0,0,0);
      const gYear = d.getFullYear();
      
      // Determine which PB year this date belongs to.
      // PB Year starts around Dec 21.
      let solsticeYear = gYear;
      let solstice = getWinterSolstice(solsticeYear);
      
      if (d < solstice) {
        solsticeYear = gYear - 1;
        solstice = getWinterSolstice(solsticeYear);
      }
      
      // PB Year number
      const pbYear = (solsticeYear + 1) + EPOCH_OFFSET; 
      
      // Calculate days since Solstice (Eni)
      const msPerDay = 24 * 60 * 60 * 1000;
      // Rounding to avoid DST issues
      let daysSinceSolstice = Math.round((d - solstice) / msPerDay);
      
      // Day 0 is Eni
      if (daysSinceSolstice === 0) {
        return { year: pbYear, month: 0, day: 1, isEni: true, isBehti: false, gregorianDate: d };
      }
      
      let remainingDays = daysSinceSolstice - 1; // Subtract Eni
      
      // Months 1-6
      for (let i = 0; i < 6; i++) {
        if (remainingDays < MONTHS[i].days) {
          return {
            year: pbYear,
            month: MONTHS[i].id,
            day: remainingDays + 1,
            isEni: false,
            isBehti: false,
            gregorianDate: d
          };
        }
        remainingDays -= MONTHS[i].days;
      }
      
      // Check Behti (after Month 6)
      // PB Year X corresponds to Gregorian Year X - 5505.
      // The leap day is in that Gregorian Year.
      if (isPBYearLeap(pbYear)) {
        if (remainingDays === 0) {
          return { year: pbYear, month: 13, day: 1, isEni: false, isBehti: true, gregorianDate: d };
        }
        remainingDays--; // Subtract Behti
      }
      
      // Months 7-12
      for (let i = 6; i < 12; i++) {
         if (remainingDays < MONTHS[i].days) {
          return {
            year: pbYear,
            month: MONTHS[i].id,
            day: remainingDays + 1,
            isEni: false,
            isBehti: false,
            gregorianDate: d
          };
        }
        remainingDays -= MONTHS[i].days;
      }
      
      // Fallback (should not happen usually, maybe end of year overlap?)
      return { year: pbYear + 1, month: 0, day: 1, isEni: true, isBehti: false, gregorianDate: d };
    }

    function pbToGregorian(pbYear, pbMonth, pbDay) {
      // pbYear 7530 -> solsticeYear 2024 (starts Dec 2024)
      const solsticeYear = pbYear - EPOCH_OFFSET - 1;
      const solstice = getWinterSolstice(solsticeYear);
      let daysToAdd = 0;
      
      if (pbMonth === 0) { // Eni
        daysToAdd = 0;
      } else {
        daysToAdd += 1; // Eni
        
        // Months before target
        // Handle Behti
        const targetMonthIndex = (pbMonth === 13) ? 6 : (pbMonth > 13 ? 12 : pbMonth - 1);
        // But wait, 13 is Behti.
        
        // Sum days
        // 1. Months 1 to (min(month-1, 6))
        const limit1 = (pbMonth === 13) ? 6 : Math.min(pbMonth - 1, 6);
        for (let i = 0; i < limit1; i++) daysToAdd += MONTHS[i].days;
        
        // 2. Behti
        if ((pbMonth === 13 || pbMonth > 6) && isPBYearLeap(pbYear)) {
             // If we are AT Behti (13), we don't add it yet (it's the current day calc below) 
             // If we are AFTER Behti (Month 7+), we add it.
             if (pbMonth > 6 && pbMonth !== 13) daysToAdd += 1;
        }
        
        // 3. Months 7 to month-1
        if (pbMonth > 6 && pbMonth !== 13) {
          for (let i = 6; i < pbMonth - 1; i++) daysToAdd += MONTHS[i].days;
        }
        
        // 4. Current day
        daysToAdd += (pbDay - 1);
      }
      
      const result = new Date(solstice);
      result.setDate(result.getDate() + daysToAdd);
      result.setHours(0,0,0,0);
      return result;
    }

    function getMonthDays(pbYear, pbMonth) {
      if (pbMonth === 0) { // Eni
        return [{ pbDay: 1, pbMonth: 0, pbYear, gregorianDate: pbToGregorian(pbYear, 0, 1), isEni: true }];
      }
      if (pbMonth === 13) { // Behti
        return [{ pbDay: 1, pbMonth: 13, pbYear, gregorianDate: pbToGregorian(pbYear, 13, 1), isBehti: true }];
      }

      const monthIdx = pbMonth - 1;
      const month = MONTHS[monthIdx];
      if (!month) return [];
      
      const days = [];
      for (let day = 1; day <= month.days; day++) {
        const gregorian = pbToGregorian(pbYear, pbMonth, day);
        days.push({ pbDay: day, pbMonth, pbYear, gregorianDate: gregorian });
      }
      return days;
    }

    // Get the sequence of viewable entities for a year
    function getYearStructure(pbYear) {
      const struct = [0]; // Eni
      for(let i=1; i<=6; i++) struct.push(i);
      if (isPBYearLeap(pbYear)) struct.push(13); // Behti
      for(let i=7; i<=12; i++) struct.push(i);
      return struct;
    }

    function isSameDay(d1, d2) {
      if (!d1 || !d2) return false;
      return d1.year === d2.year && d1.month === d2.month && d1.day === d2.day;
    }

    // ===== LOCALIZATION =====
    const TRANSLATIONS = {
      bg: {
        tutorial: {
          welcome: "–î–æ–±—Ä–µ –¥–æ—à–ª–∏ –≤ –ò–º–µ–Ω–Ω–∏–∫",
          welcomeDesc: "–û—Ç–∫—Ä–∏–π—Ç–µ –¥—Ä–µ–≤–Ω–∏—è –ø—Ä–∞–±—ä–ª–≥–∞—Ä—Å–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä - –µ–¥–Ω–∞ –æ—Ç –Ω–∞–π-—Ç–æ—á–Ω–∏—Ç–µ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–∏ —Å–∏—Å—Ç–µ–º–∏ –≤ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞.",
          skip: "–ü—Ä–æ–ø—É—Å–Ω–∏",
          next: "–ù–∞–ø—Ä–µ–¥",
          start: "–ó–∞–ø–æ—á–Ω–∏"
        },
        view: {
          month: "–ú–µ—Å–µ—Ü",
          week: "–°–µ–¥–º–∏—Ü–∞",
          day: "–î–µ–Ω",
          year: "–ì–æ–¥–∏–Ω–∞"
        },
        settings: {
          appearance: "–ò–∑–≥–ª–µ–¥",
          theme: "–¢–µ–º–∞",
          traditional: "–¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∞",
          modern: "–ú–æ–¥–µ—Ä–Ω–∞",
          mode: "–†–µ–∂–∏–º",
          light: "–°–≤–µ—Ç—ä–ª",
          dark: "–¢—ä–º–µ–Ω",
          language: "–ï–∑–∏–∫",
          lang: "–ï–∑–∏–∫",
          bg: "–ë—ä–ª–≥–∞—Ä—Å–∫–∏",
          en: "English",
          terms: "–¢–µ—Ä–º–∏–Ω–∏",
          proto: "–ü—Ä–∞–±—ä–ª–≥–∞—Ä—Å–∫–∏",
          modernTerms: "–°—ä–≤—Ä–µ–º–µ–Ω–Ω–∏",
          calendar: "–ö–∞–ª–µ–Ω–¥–∞—Ä",
          weekStart: "–ù–∞—á–∞–ª–æ –Ω–∞ —Å–µ–¥–º–∏—Ü–∞—Ç–∞",
          monday: "–ü–æ–Ω–µ–¥–µ–ª–Ω–∏–∫",
          sunday: "–ù–µ–¥–µ–ª—è",
          showGregorian: "–ü–æ–∫–∞–∑–≤–∞–π –≥—Ä–∏–≥–æ—Ä–∏–∞–Ω—Å–∫–∏",
          yes: "–î–∞",
          no: "–ù–µ",
          data: "–î–∞–Ω–Ω–∏"
        },
        btn: {
          export: "üì• –ï–∫—Å–ø–æ—Ä—Ç ICS",
          import: "üì§ –ò–º–ø–æ—Ä—Ç ICS",
          tutorial: "üìñ –ü–æ–≤—Ç–æ—Ä–∏ —É—Ä–æ–∫–∞",
          cancel: "–û—Ç–∫–∞–∑",
          save: "–ó–∞–ø–∞–∑–∏"
        },
        nav: {
          add: "–î–æ–±–∞–≤–∏",
          today: "–î–Ω–µ—Å",
          settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏"
        },
        modal: {
          addEvent: "–î–æ–±–∞–≤–∏ —Å—ä–±–∏—Ç–∏–µ",
          editEvent: "–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π —Å—ä–±–∏—Ç–∏–µ",
          title: "–ó–∞–≥–ª–∞–≤–∏–µ",
          desc: "–û–ø–∏—Å–∞–Ω–∏–µ",
          date: "–î–∞—Ç–∞",
          time: "–ß–∞—Å (–ø–æ –∏–∑–±–æ—Ä)",
          recurrence: "–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ"
        },
        rec: {
          none: "–ù—è–º–∞",
          daily: "–î–Ω–µ–≤–Ω–æ",
          weekly: "–°–µ–¥–º–∏—á–Ω–æ",
          monthly: "–ú–µ—Å–µ—á–Ω–æ",
          yearly: "–ì–æ–¥–∏—à–Ω–æ",
          animal: "–ù–∞ 12 –≥–æ–¥–∏–Ω–∏ (–∂–∏–≤–æ—Ç–∏–Ω—Å–∫–∏ —Ü–∏–∫—ä–ª)",
          starday: "–ù–∞ 60 –≥–æ–¥–∏–Ω–∏ (–∑–≤–µ–∑–¥–µ–Ω –¥–µ–Ω)"
        },
        empty: "üìÖ –ù—è–º–∞ —Å—ä–±–∏—Ç–∏—è",
        weekdays: ["–ù–¥", "–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±"],
        yearOf: "–ì–æ–¥–∏–Ω–∞ –Ω–∞"
      },
      en: {
        tutorial: {
          welcome: "Welcome to Imennik",
          welcomeDesc: "Discover the ancient Proto-Bulgarian calendar - one of the most accurate calendar systems in history.",
          skip: "Skip",
          next: "Next",
          start: "Start"
        },
        view: {
          month: "Month",
          week: "Week",
          day: "Day",
          year: "Year"
        },
        settings: {
          appearance: "Appearance",
          theme: "Theme",
          traditional: "Traditional",
          modern: "Modern",
          mode: "Mode",
          light: "Light",
          dark: "Dark",
          language: "Language",
          lang: "Language",
          bg: "Bulgarian",
          en: "English",
          terms: "Terms",
          proto: "Proto-Bulgarian",
          modernTerms: "Modern",
          calendar: "Calendar",
          weekStart: "Week Start",
          monday: "Monday",
          sunday: "Sunday",
          showGregorian: "Show Gregorian",
          yes: "Yes",
          no: "No",
          data: "Data"
        },
        btn: {
          export: "üì• Export ICS",
          import: "üì§ Import ICS",
          tutorial: "üìñ Replay Tutorial",
          cancel: "Cancel",
          save: "Save"
        },
        nav: {
          add: "Add",
          today: "Today",
          settings: "Settings"
        },
        modal: {
          addEvent: "Add Event",
          editEvent: "Edit Event",
          title: "Title",
          desc: "Description",
          date: "Date",
          time: "Time (optional)",
          recurrence: "Recurrence"
        },
        rec: {
          none: "None",
          daily: "Daily",
          weekly: "Weekly",
          monthly: "Monthly",
          yearly: "Yearly",
          animal: "Every 12 years (animal cycle)",
          starday: "Every 60 years (star day)"
        },
        empty: "üìÖ No events",
        weekdays: ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"],
        yearOf: "Year of the"
      }
    };

    function t(obj) {
      if (!obj) return '';
      if (state.settings.useProto) {
        if (state.settings.lang === 'en' && obj.protoEn) return obj.protoEn;
        if (obj.proto) return obj.proto;
      }
      return state.settings.lang === 'bg' ? (obj.bg || obj.en) : obj.en;
    }
    
    function localize() {
      const lang = state.settings.lang;
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        const keys = key.split('.');
        let val = TRANSLATIONS[lang];
        keys.forEach(k => { if(val) val = val[k]; });
        
        if (val) {
          if (el.tagName === 'INPUT' && el.getAttribute('placeholder')) {
             // For placeholders
          } else {
             el.textContent = val;
          }
        }
      });
    }

    // ===== INDEXEDDB =====
    let db = null;
    
    async function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('imennik', 1);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => { db = request.result; resolve(db); };
        request.onupgradeneeded = (e) => {
          const database = e.target.result;
          if (!database.objectStoreNames.contains('events')) {
            database.createObjectStore('events', { keyPath: 'id' });
          }
          if (!database.objectStoreNames.contains('settings')) {
            database.createObjectStore('settings', { keyPath: 'key' });
          }
        };
      });
    }

    async function loadSettings() {
      return new Promise((resolve) => {
        const tx = db.transaction('settings', 'readonly');
        const store = tx.objectStore('settings');
        const request = store.get('settings');
        request.onsuccess = () => {
          if (request.result) {
            state.settings = { ...state.settings, ...request.result.value };
          }
          resolve();
        };
        request.onerror = () => resolve();
      });
    }

    async function saveSettings() {
      const tx = db.transaction('settings', 'readwrite');
      const store = tx.objectStore('settings');
      store.put({ key: 'settings', value: state.settings });
    }

    async function loadEvents() {
      return new Promise((resolve) => {
        const tx = db.transaction('events', 'readonly');
        const store = tx.objectStore('events');
        const request = store.getAll();
        request.onsuccess = () => {
          state.events = request.result || [];
          resolve();
        };
        request.onerror = () => resolve();
      });
    }

    async function saveEvent(event) {
      const tx = db.transaction('events', 'readwrite');
      const store = tx.objectStore('events');
      store.put(event);
      await loadEvents();
    }

    async function deleteEvent(id) {
      const tx = db.transaction('events', 'readwrite');
      const store = tx.objectStore('events');
      store.delete(id);
      await loadEvents();
    }

    // ===== UI RENDERING =====
    function applyTheme() {
      document.documentElement.setAttribute('data-theme', state.settings.theme);
      document.documentElement.setAttribute('data-mode', state.settings.mode);
    }

    function updateHeader() {
      const pd = state.selectedDate;
      if (!pd) return; 

      const animal = getAnimalForYear(pd.year);
      const element = getElementForYear(pd.year);
      const gender = getGenderForYear(pd.year);
      
      const yearOf = TRANSLATIONS[state.settings.lang].yearOf;
      document.getElementById('header-year').textContent = `${yearOf} ${t(animal)} ${pd.year}`;
      document.getElementById('header-element').textContent = `${t(element)} ‚Ä¢ ${t(gender)}`;
      
      // Use dark mode friendly color if in dark mode
      const elColor = (state.settings.mode === 'dark' && element.colorDark) ? element.colorDark : element.color;
      document.getElementById('header-element').style.color = elColor;
      
      document.getElementById('header-animal').textContent = animal.emoji;
    }

    function renderWeekdayHeader() {
      const container = document.getElementById('weekday-header');
      if (!container) return; // Safety check
      container.innerHTML = '';
      
      const langWeekdays = TRANSLATIONS[state.settings.lang].weekdays;
      let weekdayIndices = [0, 1, 2, 3, 4, 5, 6];
      if (state.settings.weekStartsOn === 1) {
        weekdayIndices = [1, 2, 3, 4, 5, 6, 0];
      }
      
      weekdayIndices.forEach(idx => {
        const cell = document.createElement('div');
        cell.className = 'weekday-cell';
        cell.textContent = langWeekdays[idx];
        container.appendChild(cell);
      });
    }

    function getEventsForDate(pd) {
      return state.events.filter(e => 
        e.pbYear === pd.year && e.pbMonth === pd.month && e.pbDay === pd.day
      );
    }

    function getEntityName(id) {
        if (id === 0) return t(DAY_ENI);
        if (id === 13) return t(DAY_BEHTI);
        return t(MONTHS[id - 1]);
    }

    function getHolidaysForDate(date) {
      const m = date.getMonth(); // 0-11
      const d = date.getDate();
      const holidays = [];
      
      // Solar Events (Approximate)
      if (m === 2 && d === 20) holidays.push({ type: 'solar', name: { bg: '–ü—Ä–æ–ª–µ—Ç–Ω–æ —Ä–∞–≤–Ω–æ–¥–µ–Ω—Å—Ç–≤–∏–µ', en: 'Spring Equinox' } });
      if (m === 5 && d === 21) holidays.push({ type: 'solar', name: { bg: '–õ—è—Ç–Ω–æ —Å–ª—ä–Ω—Ü–µ—Å—Ç–æ–µ–Ω–µ', en: 'Summer Solstice' } });
      if (m === 8 && d === 23) holidays.push({ type: 'solar', name: { bg: '–ï—Å–µ–Ω–Ω–æ —Ä–∞–≤–Ω–æ–¥–µ–Ω—Å—Ç–≤–∏–µ', en: 'Autumn Equinox' } });
      if (m === 11 && d === 21) holidays.push({ type: 'solar', name: { bg: '–ó–∏–º–Ω–æ —Å–ª—ä–Ω—Ü–µ—Å—Ç–æ–µ–Ω–µ', en: 'Winter Solstice' } });

      // BG Holidays
      if (m === 2 && d === 1) holidays.push({ type: 'tradition', name: { bg: '–ë–∞–±–∞ –ú–∞—Ä—Ç–∞', en: 'Baba Marta' } });
      if (m === 2 && d === 3) holidays.push({ type: 'national', name: { bg: '–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ—Ç–æ', en: 'Liberation Day' } });
      if (m === 4 && d === 6) holidays.push({ type: 'tradition', name: { bg: '–ì–µ—Ä–≥—å–æ–≤–¥–µ–Ω', en: 'St. George\'s Day' } });
      if (m === 4 && d === 24) holidays.push({ type: 'national', name: { bg: '24 –ú–∞–π', en: 'Culture Day' } });
      if (m === 8 && d === 6) holidays.push({ type: 'national', name: { bg: '–°—ä–µ–¥–∏–Ω–µ–Ω–∏–µ—Ç–æ', en: 'Unification Day' } });
      if (m === 8 && d === 22) holidays.push({ type: 'national', name: { bg: '–ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—Ç–∞', en: 'Independence Day' } });
      if (m === 10 && d === 1) holidays.push({ type: 'national', name: { bg: '–î–µ–Ω –Ω–∞ –±—É–¥–∏—Ç–µ–ª–∏—Ç–µ', en: 'Awakeners Day' } });
      if (m === 11 && d === 25) holidays.push({ type: 'tradition', name: { bg: '–ö–æ–ª–µ–¥–∞', en: 'Christmas' } });
      
      return holidays;
    }

    function formatGregorianDate(date, includeYear = false) {
      const d = date.getDate();
      const m = date.getMonth() + 1;
      const y = date.getFullYear();
      if (state.settings.lang === 'bg') {
        return includeYear ? `${d}/${m}/${y}` : `${d}/${m}`;
      } else {
        return includeYear ? `${m}/${d}/${y}` : `${m}/${d}`;
      }
    }

    function renderMonthView() {
      const pd = state.selectedDate;
      const days = getMonthDays(pd.year, pd.month);
      
      const title = getEntityName(pd.month);
      document.getElementById('month-title').textContent = `${title} ${pd.year}`;
      
      // If Eni or Behti (single day special view)
      if (pd.month === 0 || pd.month === 13) {
          if(document.getElementById('weekday-header')) document.getElementById('weekday-header').style.display = 'none';
          const grid = document.getElementById('calendar-grid');
          if (!grid) return;
          grid.innerHTML = '';
          grid.style.display = 'flex';
          grid.style.justifyContent = 'center';
          grid.style.padding = '20px';

          const day = days[0];
          const cell = document.createElement('div');
          cell.className = `calendar-day ${pd.month === 0 ? 'eni' : 'behti'} selected`;
          cell.style.width = '100px';
          cell.style.height = '100px';
          cell.style.fontSize = '1.5rem';
          
          const events = getEventsForDate(pd);
          const holidays = getHolidaysForDate(day.gregorianDate);
          
          let dotsHtml = '';
          if (events.length > 0) dotsHtml += '<span class="event-dot"></span>';
          holidays.forEach(h => {
             dotsHtml += `<span class="holiday-dot ${h.type}" title="${state.settings.lang === 'bg' ? h.name.bg : h.name.en}"></span>`;
          });
          
          cell.innerHTML = `
            <span>${pd.month === 0 ? '‚ú¶' : '‚òÖ'}</span>
            ${state.settings.showGregorian ? `<span class="day-gregorian" style="font-size:0.8rem">${formatGregorianDate(day.gregorianDate)}</span>` : ''}
            ${dotsHtml}
          `;
           cell.addEventListener('click', () => {
             // Already selected
           });
           grid.appendChild(cell);
           return;
      }

      // Standard Month
      if(document.getElementById('weekday-header')) document.getElementById('weekday-header').style.display = 'grid';
      const grid = document.getElementById('calendar-grid');
      if (!grid) return;
      grid.style.display = 'grid';
      grid.style.justifyContent = 'initial';
      grid.style.padding = '0';
      
      renderWeekdayHeader();
      
      grid.innerHTML = '';
      
      if (days.length === 0) return;
      
      const firstDayWeekday = days[0].gregorianDate.getDay();
      let startPadding = firstDayWeekday;
      if (state.settings.weekStartsOn === 1) {
        startPadding = firstDayWeekday === 0 ? 6 : firstDayWeekday - 1;
      }
      
      for (let i = 0; i < startPadding; i++) {
        const empty = document.createElement('div');
        empty.className = 'calendar-day empty';
        grid.appendChild(empty);
      }
      
      const today = gregorianToPB(new Date());
      
      days.forEach(day => {
        const cell = document.createElement('div');
        cell.className = 'calendar-day';
        
        const dayPd = { year: pd.year, month: pd.month, day: day.pbDay };
        if (isSameDay(dayPd, today)) cell.classList.add('today');
        if (isSameDay(dayPd, state.selectedDate)) cell.classList.add('selected');
        
        const events = getEventsForDate(dayPd);
        const holidays = getHolidaysForDate(day.gregorianDate);
        
        let dotsHtml = '';
        if (events.length > 0) dotsHtml += '<span class="event-dot"></span>';
        holidays.forEach(h => {
           // Shift position slightly for multiple dots? For now, just absolute positioning might overlap.
           // A better approach for multiple dots is a container, but sticking to requested simple absolute dot for now.
           // If we want them distinct, we might need a container.
           // Let's assume one main holiday per day or simple overlap is acceptable for this iteration, 
           // OR we can make a container.
           // Given the CSS 'top: 4px; right: 4px', they will stack.
           // Let's rely on the CSS classes provided.
           dotsHtml += `<span class="holiday-dot ${h.type}" title="${state.settings.lang === 'bg' ? h.name.bg : h.name.en}"></span>`;
        });
        
        cell.innerHTML = `
          <span>${day.pbDay}</span>
          ${state.settings.showGregorian ? `<span class="day-gregorian">${formatGregorianDate(day.gregorianDate)}</span>` : ''}
          ${dotsHtml}
        `;
        
        cell.addEventListener('click', () => {
          state.selectedDate = { ...state.selectedDate, day: day.pbDay, gregorianDate: day.gregorianDate };
          render();
        });
        
        grid.appendChild(cell);
      });
    }

    function renderWeekView() {
      const pd = state.selectedDate;
      const baseDate = pd.gregorianDate || pbToGregorian(pd.year, pd.month, pd.day);
      const dayOfWeek = baseDate.getDay();
      const startOffset = state.settings.weekStartsOn === 1 
        ? (dayOfWeek === 0 ? -6 : 1 - dayOfWeek)
        : -dayOfWeek;
      
      const startDate = new Date(baseDate);
      startDate.setDate(startDate.getDate() + startOffset);
      
      const today = gregorianToPB(new Date());
      const grid = document.getElementById('week-grid');
      if (!grid) return;
      grid.innerHTML = '';
      
      const langWeekdays = TRANSLATIONS[state.settings.lang].weekdays;
      
      for (let i = 0; i < 7; i++) {
        const date = new Date(startDate);
        date.setDate(date.getDate() + i);
        const dayPd = gregorianToPB(date);
        const events = getEventsForDate(dayPd);
        const holidays = getHolidaysForDate(date);
        const isToday = isSameDay(dayPd, today);
        
        const row = document.createElement('div');
        row.className = `week-day-row ${isToday ? 'today' : ''}`;
        
        let dayDisplay = dayPd.day;
        if (dayPd.isEni) dayDisplay = '‚ú¶';
        if (dayPd.isBehti) dayDisplay = '‚òÖ';

        let holidayHtml = '';
        holidays.forEach(h => {
            const name = state.settings.lang === 'bg' ? h.name.bg : h.name.en;
            holidayHtml += `<div class="holiday-name holiday-text ${h.type}">${name}</div>`;
        });

        row.innerHTML = `
          <div class="week-day-date">
            <span class="week-day-name">${langWeekdays[date.getDay()]}</span>
            <span class="week-day-number">${dayDisplay}</span>
            ${state.settings.showGregorian ? `<span class="day-gregorian">${formatGregorianDate(date)}</span>` : ''}
          </div>
          <div class="week-day-events">
            ${holidayHtml}
            ${events.length === 0 ? (holidayHtml ? '' : '<span style="color:var(--color-text-tertiary)">‚Äî</span>') :
              events.map(e => `<div class="event-card" onclick="openEventModal('${e.id}')"><div class="event-title">${e.title}</div></div>`).join('')}
          </div>
        `;
        row.addEventListener('click', (e) => {
          if (!e.target.closest('.event-card')) {
            state.selectedDate = dayPd;
            render();
          }
        });
        grid.appendChild(row);
      }
      
      const firstDay = gregorianToPB(startDate);
      const endDate = new Date(startDate);
      endDate.setDate(endDate.getDate() + 6);
      const lastDay = gregorianToPB(endDate);
      document.getElementById('week-title').textContent = `${firstDay.day || (firstDay.isEni?'‚ú¶':'‚òÖ')}-${lastDay.day || (lastDay.isEni?'‚ú¶':'‚òÖ')} ${getEntityName(firstDay.month)}`;
    }

    function renderDayView() {
      const pd = state.selectedDate;
      const events = getEventsForDate(pd);
      
      let dayText = pd.day;
      let monthText = '';
      
      if (pd.month === 0) { dayText = '‚ú¶'; monthText = '–ï–ù–ò'; }
      else if (pd.month === 13) { dayText = '‚òÖ'; monthText = '–ë–ï–•–¢–ò'; }
      else { monthText = t(MONTHS[pd.month - 1]); }
      
      document.getElementById('day-date').textContent = dayText;
      document.getElementById('day-month').textContent = monthText;
      
      const gd = pd.gregorianDate || pbToGregorian(pd.year, pd.month, pd.day);
      document.getElementById('day-gregorian').textContent = state.settings.showGregorian 
        ? `${formatGregorianDate(gd, true)}` : '';
      
      const holidays = getHolidaysForDate(gd);
      let holidayHtml = '';
      holidays.forEach(h => {
          const name = state.settings.lang === 'bg' ? h.name.bg : h.name.en;
          holidayHtml += `<div class="holiday-name holiday-text ${h.type}" style="font-size: 1rem; margin-bottom: 8px;">${name}</div>`;
      });

      const container = document.getElementById('day-events');
      if (events.length === 0 && holidays.length === 0) {
        container.innerHTML = `<div class="empty-state">${TRANSLATIONS[state.settings.lang].empty}</div>`;
      } else {
        container.innerHTML = holidayHtml + events.map(e => `
          <div class="event-card" onclick="openEventModal('${e.id}')">
            ${e.hour !== undefined && e.hour !== '' ? `<div class="event-time">${String(e.hour).padStart(2,'0')}:${String(e.minute||0).padStart(2,'0')}</div>` : ''}
            <div>
              <div class="event-title">${e.title}</div>
              ${e.description ? `<div class="event-description">${e.description}</div>` : ''}
            </div>
          </div>
        `).join('');
      }
    }

    function renderYearView() {
      const pd = state.selectedDate;
      const today = gregorianToPB(new Date());
      
      document.getElementById('year-title').textContent = pd.year;
      
      const grid = document.getElementById('year-grid');
      if (!grid) return;
      grid.innerHTML = '';
      
      const structure = getYearStructure(pd.year);

      structure.forEach(entityId => {
        const card = document.createElement('div');
        const isCurrent = pd.month === entityId;
        card.className = `year-month-card ${isCurrent ? 'current' : ''}`;
        
        let title = getEntityName(entityId);
        
        let miniGrid = '';
        if (entityId === 0) { // Eni
            const isToday = isSameDay({ year: pd.year, month: 0, day: 1 }, today);
            miniGrid = `<div class="mini-day ${isToday ? 'today' : ''}" style="width:100%;text-align:center">‚ú¶</div>`;
        } else if (entityId === 13) { // Behti
            const isToday = isSameDay({ year: pd.year, month: 13, day: 1 }, today);
            miniGrid = `<div class="mini-day ${isToday ? 'today' : ''}" style="width:100%;text-align:center">‚òÖ</div>`;
        } else {
            const days = getMonthDays(pd.year, entityId);
            days.forEach(d => {
              const isToday = isSameDay({ year: pd.year, month: entityId, day: d.pbDay }, today);
              const holidays = getHolidaysForDate(d.gregorianDate);
              
              let classes = 'mini-day';
              if (isToday) classes += ' today';
              if (holidays.length > 0) classes += ` ${holidays[0].type}`;
              
              miniGrid += `<div class="${classes}">${d.pbDay}</div>`;
            });
        }
        
        card.innerHTML = `
          <div class="year-month-title">${title}</div>
          <div class="year-month-mini-grid">${miniGrid}</div>
        `;
        
        card.addEventListener('click', () => {
          state.selectedDate = { ...state.selectedDate, month: entityId, day: 1 };
          state.currentView = 'month';
          render();
        });
        
        grid.appendChild(card);
      });
    }

    function render() {
      localize();
      applyTheme();
      updateHeader();
      
      document.querySelectorAll('.view-switch-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === state.currentView);
      });
      
      document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
      if(document.getElementById(`view-${state.currentView}`)) 
        document.getElementById(`view-${state.currentView}`).style.display = 'block';
      
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      if(document.getElementById(`page-${state.currentPage}`)) 
        document.getElementById(`page-${state.currentPage}`).classList.add('active');
      
      document.querySelectorAll('.bottom-nav-item[data-page]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.page === state.currentPage);
      });
      
      // Update Bottom Nav Active States (Custom logic for replaced buttons)
      document.getElementById('today-btn').classList.toggle('active', state.currentPage === 'calendar');
      
      // Removed FAB display logic because FAB is removed
      
      if (state.currentPage === 'calendar') {
        switch (state.currentView) {
          case 'month': renderMonthView(); break;
          case 'week': renderWeekView(); break;
          case 'day': renderDayView(); break;
          case 'year': renderYearView(); break;
        }
      }
      
      renderSettings();
    }

    function renderSettings() {
      // Theme
      document.getElementById('opt-theme-traditional').classList.toggle('active', state.settings.theme === 'traditional');
      document.getElementById('opt-theme-modern').classList.toggle('active', state.settings.theme === 'modern');
      
      // Mode
      document.getElementById('opt-mode-light').classList.toggle('active', state.settings.mode === 'light');
      document.getElementById('opt-mode-dark').classList.toggle('active', state.settings.mode === 'dark');
      
      // Lang
      document.getElementById('opt-lang-bg').classList.toggle('active', state.settings.lang === 'bg');
      document.getElementById('opt-lang-en').classList.toggle('active', state.settings.lang === 'en');
      
      // Terms
      document.getElementById('opt-terms-proto').classList.toggle('active', state.settings.useProto);
      document.getElementById('opt-terms-modern').classList.toggle('active', !state.settings.useProto);
      
      // Week Start
      document.getElementById('opt-week-mon').classList.toggle('active', state.settings.weekStartsOn === 1);
      document.getElementById('opt-week-sun').classList.toggle('active', state.settings.weekStartsOn === 0);
      
      // Gregorian
      document.getElementById('opt-greg-on').classList.toggle('active', state.settings.showGregorian);
      document.getElementById('opt-greg-off').classList.toggle('active', !state.settings.showGregorian);
    }

    // ===== TUTORIAL =====
    function renderTutorial() {
      const slide = TUTORIAL_SLIDES[state.tutorialSlide];
      document.getElementById('tutorial-icon').textContent = slide.icon;
      document.getElementById('tutorial-title').textContent = slide.title;
      document.getElementById('tutorial-desc').textContent = slide.desc;
      
      const dots = document.getElementById('tutorial-dots');
      dots.innerHTML = TUTORIAL_SLIDES.map((_, i) => 
        `<div class="tutorial-dot ${i === state.tutorialSlide ? 'active' : ''}"></div>`
      ).join('');
      
      document.getElementById('tutorial-next').textContent = 
        state.tutorialSlide === TUTORIAL_SLIDES.length - 1 ? '–ó–∞–ø–æ—á–Ω–∏' : '–ù–∞–ø—Ä–µ–¥';
    }

    function showTutorial() {
      state.tutorialSlide = 0;
      document.getElementById('tutorial').classList.remove('hidden');
      renderTutorial();
    }

    function closeTutorial() {
      document.getElementById('tutorial').classList.add('hidden');
      state.settings.tutorialDone = true;
      saveSettings();
    }

    // ===== EVENT MODAL =====
    function openEventModal(eventId = null) {
      const modal = document.getElementById('event-modal');
      modal.classList.remove('hidden');
      
      const pd = state.selectedDate;
      
      // Populate year dropdown
      const yearSelect = document.getElementById('event-year');
      yearSelect.innerHTML = '';
      for (let y = pd.year - 10; y <= pd.year + 50; y++) {
        const animal = getAnimalForYear(y);
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = `${y} ${t(animal)}`;
        if (y === pd.year) opt.selected = true;
        yearSelect.appendChild(opt);
      }
      
      // Populate month dropdown with Eni/Behti
      const monthSelect = document.getElementById('event-month');
      monthSelect.innerHTML = '';
      
      const structure = getYearStructure(pd.year);
      structure.forEach(mid => {
        const opt = document.createElement('option');
        opt.value = mid;
        opt.textContent = getEntityName(mid);
        if (mid === (pd.month)) opt.selected = true;
        monthSelect.appendChild(opt);
      });
      
      // Populate day dropdown
      updateDaySelect();
      
      // Populate hour dropdown
      const hourSelect = document.getElementById('event-hour');
      hourSelect.innerHTML = '<option value="">--</option>';
      for (let h = 0; h < 24; h++) {
        const opt = document.createElement('option');
        opt.value = h;
        opt.textContent = String(h).padStart(2, '0');
        hourSelect.appendChild(opt);
      }
      
      // Populate minute dropdown
      const minuteSelect = document.getElementById('event-minute');
      minuteSelect.innerHTML = '<option value="">--</option>';
      [0, 15, 30, 45].forEach(m => {
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = String(m).padStart(2, '0');
        minuteSelect.appendChild(opt);
      });
      
      if (eventId) {
        const event = state.events.find(e => e.id === eventId);
        if (event) {
          state.editingEvent = event;
          document.getElementById('modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π —Å—ä–±–∏—Ç–∏–µ';
          document.getElementById('event-title').value = event.title;
          document.getElementById('event-desc').value = event.description || '';
          document.getElementById('event-year').value = event.pbYear;
          document.getElementById('event-month').value = event.pbMonth;
          updateDaySelect();
          document.getElementById('event-day').value = event.pbDay;
          document.getElementById('event-hour').value = event.hour !== undefined ? event.hour : '';
          document.getElementById('event-minute').value = event.minute !== undefined ? event.minute : '';
          document.getElementById('event-recurrence').value = event.recurrence || 'none';
          document.getElementById('event-delete').style.display = 'block';
        }
      } else {
        state.editingEvent = null;
        document.getElementById('modal-title').textContent = '–î–æ–±–∞–≤–∏ —Å—ä–±–∏—Ç–∏–µ';
        document.getElementById('event-title').value = '';
        document.getElementById('event-desc').value = '';
        document.getElementById('event-day').value = pd.day || 1;
        document.getElementById('event-hour').value = '';
        document.getElementById('event-minute').value = '';
        document.getElementById('event-recurrence').value = 'none';
        document.getElementById('event-delete').style.display = 'none';
      }
    }
    
    function updateDaySelect() {
      const monthVal = parseInt(document.getElementById('event-month').value);
      const pbYear = parseInt(document.getElementById('event-year').value);
      const daySelect = document.getElementById('event-day');
      const currentDay = parseInt(daySelect.value) || 1;
      
      let maxDays = 1;
      if (monthVal === 0) maxDays = 1; // Eni
      else if (monthVal === 13) maxDays = 1; // Behti
      else maxDays = MONTHS[monthVal - 1].days;

      daySelect.innerHTML = '';
      for (let d = 1; d <= maxDays; d++) {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        daySelect.appendChild(opt);
      }
      daySelect.value = Math.min(currentDay, maxDays);
    }

    function closeEventModal() {
      document.getElementById('event-modal').classList.add('hidden');
      state.editingEvent = null;
    }

    async function saveEventFromModal() {
      const title = document.getElementById('event-title').value.trim();
      if (!title) return;
      
      const pbYear = parseInt(document.getElementById('event-year').value);
      const pbMonth = parseInt(document.getElementById('event-month').value);
      const pbDay = parseInt(document.getElementById('event-day').value);
      const hour = document.getElementById('event-hour').value;
      const minute = document.getElementById('event-minute').value;
      
      const event = {
        id: state.editingEvent?.id || Date.now().toString(),
        title,
        description: document.getElementById('event-desc').value.trim(),
        pbYear,
        pbMonth,
        pbDay,
        hour: hour !== '' ? parseInt(hour) : undefined,
        minute: minute !== '' ? parseInt(minute) : undefined,
        recurrence: document.getElementById('event-recurrence').value,
        gregorianDate: pbToGregorian(pbYear, pbMonth, pbDay).toISOString(),
      };
      
      await saveEvent(event);
      closeEventModal();
      render();
    }

    // ===== EXPORT/IMPORT =====
    function exportICS() {
      const lines = ['BEGIN:VCALENDAR', 'VERSION:2.0', 'PRODID:-//Imennik//Proto-Bulgarian Calendar//EN'];
      
      state.events.forEach(e => {
        const d = new Date(e.gregorianDate);
        const dateStr = d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        lines.push('BEGIN:VEVENT');
        lines.push(`UID:${e.id}@imennik`);
        lines.push(`DTSTAMP:${dateStr}`);
        lines.push(`DTSTART:${dateStr}`);
        lines.push(`SUMMARY:${e.title}`);
        if (e.description) lines.push(`DESCRIPTION:${e.description}`);
        lines.push('END:VEVENT');
      });
      
      lines.push('END:VCALENDAR');
      
      const blob = new Blob([lines.join('\r\n')], { type: 'text/calendar' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'imennik-calendar.ics';
      a.click();
      URL.revokeObjectURL(url);
    }

    async function importICS(file) {
      const text = await file.text();
      const lines = text.split(/\r?\n/);
      let currentEvent = null;
      let count = 0;
      
      for (const line of lines) {
        if (line === 'BEGIN:VEVENT') {
          currentEvent = {};
        } else if (line === 'END:VEVENT' && currentEvent) {
          if (currentEvent.title && currentEvent.date) {
            const pd = gregorianToPB(currentEvent.date);
            await saveEvent({
              id: Date.now().toString() + count,
              title: currentEvent.title,
              description: currentEvent.description || '',
              pbYear: pd.year,
              pbMonth: pd.month,
              pbDay: pd.day,
              gregorianDate: currentEvent.date.toISOString(),
            });
            count++;
          }
          currentEvent = null;
        } else if (currentEvent) {
          if (line.startsWith('SUMMARY:')) currentEvent.title = line.substring(8);
          if (line.startsWith('DESCRIPTION:')) currentEvent.description = line.substring(12);
          if (line.startsWith('DTSTART:')) {
            const ds = line.substring(8);
            const year = parseInt(ds.substring(0, 4));
            const month = parseInt(ds.substring(4, 6)) - 1;
            const day = parseInt(ds.substring(6, 8));
            currentEvent.date = new Date(year, month, day);
          }
        }
      }
      
      await loadEvents();
      render();
      alert(`–ò–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω–∏ ${count} —Å—ä–±–∏—Ç–∏—è`);
    }

    // ===== SWIPE GESTURES =====
    function setupSwipeGestures() {
      let touchStartX = 0;
      let touchStartY = 0;
      let touchEndX = 0;
      let touchEndY = 0;
      
      const mainContent = document.querySelector('.main-content');
      if (!mainContent) return;
      
      mainContent.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
      }, { passive: true });
      
      mainContent.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleSwipe();
      }, { passive: true });
      
      function handleSwipe() {
        const diffX = touchEndX - touchStartX;
        const diffY = touchEndY - touchStartY;
        const threshold = 50; // min distance for swipe
        
        // Ensure swipe is horizontal and long enough
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > threshold) {
          // Right swipe (positive diff) -> Previous (direction -1)
          // Left swipe (negative diff) -> Next (direction 1)
          const direction = diffX > 0 ? -1 : 1;
          
          if (state.currentPage === 'calendar') {
             switch (state.currentView) {
               case 'month': navigateMonth(direction); break;
               case 'week': navigateWeek(direction); break;
               case 'day': navigateDay(direction); break;
               case 'year': navigateYear(direction); break;
             }
          }
        }
      }
    }

    // ===== EVENT LISTENERS =====
    function setupEventListeners() {
      setupSwipeGestures();

      // View switcher
      document.querySelectorAll('.view-switch-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          state.currentView = btn.dataset.view;
          render();
        });
      });
      
      // Bottom nav
      document.querySelectorAll('.bottom-nav-item[data-page]').forEach(btn => {
        btn.addEventListener('click', () => {
          if (btn.dataset.page === 'settings' && state.currentPage === 'settings') {
            state.currentPage = 'calendar';
          } else {
            state.currentPage = btn.dataset.page;
          }
          render();
        });
      });
      
      // Today button
      document.getElementById('today-btn').addEventListener('click', () => {
        state.selectedDate = gregorianToPB(new Date());
        state.currentPage = 'calendar';
        render();
      });

      // Add Event Button (Nav)
      document.getElementById('add-event-btn').addEventListener('click', () => openEventModal());
      
      // Navigation
      document.getElementById('prev-month').addEventListener('click', () => navigateMonth(-1));
      document.getElementById('next-month').addEventListener('click', () => navigateMonth(1));
      document.getElementById('prev-week').addEventListener('click', () => navigateWeek(-1));
      document.getElementById('next-week').addEventListener('click', () => navigateWeek(1));
      document.getElementById('prev-day').addEventListener('click', () => navigateDay(-1));
      document.getElementById('next-day').addEventListener('click', () => navigateDay(1));
      document.getElementById('prev-year').addEventListener('click', () => navigateYear(-1));
      document.getElementById('next-year').addEventListener('click', () => navigateYear(1));
      
      // Quick add (kept for legacy or if needed, though UI might hide it)
      if(document.getElementById('quick-add-btn')) {
        document.getElementById('quick-add-btn').addEventListener('click', quickAdd);
        document.getElementById('quick-add-input').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') quickAdd();
        });
      }
      
      // Event modal
      document.getElementById('modal-close').addEventListener('click', closeEventModal);
      document.getElementById('event-cancel').addEventListener('click', closeEventModal);
      document.getElementById('event-save').addEventListener('click', saveEventFromModal);
      document.getElementById('event-delete').addEventListener('click', async () => {
        if (state.editingEvent && confirm('–ò–∑—Ç—Ä–∏–π —Å—ä–±–∏—Ç–∏–µ—Ç–æ?')) {
          await deleteEvent(state.editingEvent.id);
          closeEventModal();
          render();
        }
      });
      document.getElementById('event-modal').addEventListener('click', (e) => {
        if (e.target.id === 'event-modal') closeEventModal();
      });
      document.getElementById('event-month').addEventListener('change', updateDaySelect);
      document.getElementById('event-year').addEventListener('change', () => {
         // Re-populate month to update for leap year (Behti availability)
         const year = parseInt(document.getElementById('event-year').value);
         const monthSelect = document.getElementById('event-month');
         const currentMonth = parseInt(monthSelect.value);
         monthSelect.innerHTML = '';
         getYearStructure(year).forEach(mid => {
            const opt = document.createElement('option');
            opt.value = mid;
            opt.textContent = getEntityName(mid);
            if (mid === currentMonth) opt.selected = true;
            monthSelect.appendChild(opt);
         });
         updateDaySelect();
      });

      
      // Settings controls
      // Theme
      document.getElementById('opt-theme-traditional').addEventListener('click', () => {
        state.settings.theme = 'traditional';
        saveSettings();
        render();
      });
      document.getElementById('opt-theme-modern').addEventListener('click', () => {
        state.settings.theme = 'modern';
        saveSettings();
        render();
      });
      
      // Mode
      document.getElementById('opt-mode-light').addEventListener('click', () => {
        state.settings.mode = 'light';
        saveSettings();
        render();
      });
      document.getElementById('opt-mode-dark').addEventListener('click', () => {
        state.settings.mode = 'dark';
        saveSettings();
        render();
      });
      
      // Language
      document.getElementById('opt-lang-bg').addEventListener('click', () => {
        state.settings.lang = 'bg';
        saveSettings();
        render();
      });
      document.getElementById('opt-lang-en').addEventListener('click', () => {
        state.settings.lang = 'en';
        saveSettings();
        render();
      });
      
      // Terms
      document.getElementById('opt-terms-proto').addEventListener('click', () => {
        state.settings.useProto = true;
        saveSettings();
        render();
      });
      document.getElementById('opt-terms-modern').addEventListener('click', () => {
        state.settings.useProto = false;
        saveSettings();
        render();
      });
      
      // Week Start
      document.getElementById('opt-week-mon').addEventListener('click', () => {
        state.settings.weekStartsOn = 1;
        saveSettings();
        render();
      });
      document.getElementById('opt-week-sun').addEventListener('click', () => {
        state.settings.weekStartsOn = 0;
        saveSettings();
        render();
      });
      
      // Gregorian
      document.getElementById('opt-greg-on').addEventListener('click', () => {
        state.settings.showGregorian = true;
        saveSettings();
        render();
      });
      document.getElementById('opt-greg-off').addEventListener('click', () => {
        state.settings.showGregorian = false;
        saveSettings();
        render();
      });
      
      // Tutorial
      if(document.getElementById('tutorial-btn')) document.getElementById('tutorial-btn').addEventListener('click', showTutorial);
      if(document.getElementById('tutorial-skip')) document.getElementById('tutorial-skip').addEventListener('click', closeTutorial);
      if(document.getElementById('tutorial-next')) document.getElementById('tutorial-next').addEventListener('click', () => {
        if (state.tutorialSlide < TUTORIAL_SLIDES.length - 1) {
          state.tutorialSlide++;
          renderTutorial();
        } else {
          closeTutorial();
        }
      });
      
      // Export/Import
      if(document.getElementById('export-btn')) document.getElementById('export-btn').addEventListener('click', exportICS);
      if(document.getElementById('import-btn')) document.getElementById('import-btn').addEventListener('click', () => {
        document.getElementById('import-file').click();
      });
      if(document.getElementById('import-file')) document.getElementById('import-file').addEventListener('change', (e) => {
        if (e.target.files[0]) importICS(e.target.files[0]);
      });
    }

    // ===== TRANSITIONS =====
    async function transitionHelper(dir, updateStateFn) {
      const activeView = document.getElementById(`view-${state.currentView}`);
      if (!activeView) {
        updateStateFn();
        return;
      }
      
      // 1. Snapshot old state (Clone)
      const oldView = activeView.cloneNode(true);
      const rect = activeView.getBoundingClientRect();
      const parent = activeView.parentElement;
      
      // If we are already animating, force cleanup (simple approach) or ignore
      // Ideally, we just proceed.
      
      // Prepare parent
      parent.style.position = 'relative';
      parent.style.overflow = 'hidden';
      // parent.style.minHeight = rect.height + 'px'; // Optional: lock height
      
      // Configure Old View
      oldView.style.position = 'absolute';
      oldView.style.top = activeView.offsetTop + 'px';
      oldView.style.left = activeView.offsetLeft + 'px';
      oldView.style.width = rect.width + 'px';
      oldView.style.height = rect.height + 'px';
      oldView.style.zIndex = '10';
      oldView.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
      oldView.style.backgroundColor = 'var(--color-bg-primary)';
      oldView.removeAttribute('id'); // Avoid duplicate IDs
      
      parent.appendChild(oldView);
      
      // 2. Update State & Render New View
      updateStateFn();
      
      // 3. Prepare New View
      // Next (dir=1): New comes from Right (100%), Old goes Left (-100%)
      // Prev (dir=-1): New comes from Left (-100%), Old goes Right (100%)
      const startX = dir > 0 ? '100%' : '-100%';
      const endX = dir > 0 ? '-100%' : '100%';
      
      activeView.style.transform = `translateX(${startX})`;
      activeView.style.opacity = '0';
      activeView.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
      
      // Force Reflow
      activeView.offsetHeight; 
      
      // 4. Animate
      requestAnimationFrame(() => {
        oldView.style.transform = `translateX(${endX})`;
        oldView.style.opacity = '0';
        
        activeView.style.transform = 'translateX(0)';
        activeView.style.opacity = '1';
      });
      
      // 5. Cleanup
      setTimeout(() => {
        if (oldView.parentElement) oldView.remove();
        activeView.style.transform = '';
        activeView.style.opacity = '';
        activeView.style.transition = '';
        parent.style.position = '';
        parent.style.overflow = '';
      }, 300);
    }

    function navigateMonth(dir) {
      transitionHelper(dir, () => {
        const struct = getYearStructure(state.selectedDate.year);
        const currentIdx = struct.indexOf(state.selectedDate.month);
        
        let newIdx = currentIdx + dir;
        let newYear = state.selectedDate.year;
        
        if (newIdx >= struct.length) {
          newYear++;
          const nextStruct = getYearStructure(newYear);
          newIdx = 0; // Go to Eni of next year
          state.selectedDate = {
              ...state.selectedDate,
              year: newYear,
              month: nextStruct[newIdx],
              day: 1
          };
        } else if (newIdx < 0) {
          newYear--;
          const prevStruct = getYearStructure(newYear);
          newIdx = prevStruct.length - 1; // Go to last month of prev year
          state.selectedDate = {
              ...state.selectedDate,
              year: newYear,
              month: prevStruct[newIdx],
              day: 1
          };
        } else {
          // Same year
          state.selectedDate = {
              ...state.selectedDate,
              month: struct[newIdx],
              day: 1
          };
        }
        
        state.selectedDate.gregorianDate = pbToGregorian(state.selectedDate.year, state.selectedDate.month, 1);
        render();
      });
    }

    function navigateWeek(dir) {
      transitionHelper(dir, () => {
        const gd = state.selectedDate.gregorianDate || pbToGregorian(state.selectedDate.year, state.selectedDate.month, state.selectedDate.day);
        const newDate = new Date(gd);
        newDate.setDate(newDate.getDate() + dir * 7);
        state.selectedDate = gregorianToPB(newDate);
        render();
      });
    }

    function navigateDay(dir) {
      transitionHelper(dir, () => {
        const gd = state.selectedDate.gregorianDate || pbToGregorian(state.selectedDate.year, state.selectedDate.month, state.selectedDate.day);
        const newDate = new Date(gd);
        newDate.setDate(newDate.getDate() + dir);
        state.selectedDate = gregorianToPB(newDate);
        render();
      });
    }

    function navigateYear(dir) {
      transitionHelper(dir, () => {
        state.selectedDate = { ...state.selectedDate, year: state.selectedDate.year + dir };
        // Check if current month exists in new year (Behti check)
        const struct = getYearStructure(state.selectedDate.year);
        if (!struct.includes(state.selectedDate.month)) {
            // If was Behti and new year has no Behti, go to Month 7
            state.selectedDate.month = 7; 
        }
        
        state.selectedDate.gregorianDate = pbToGregorian(state.selectedDate.year, state.selectedDate.month, state.selectedDate.day || 1);
        render();
      });
    }

    async function quickAdd() {
      const input = document.getElementById('quick-add-input');
      const title = input.value.trim();
      if (!title) return;
      
      const pd = state.selectedDate;
      await saveEvent({
        id: Date.now().toString(),
        title,
        description: '',
        pbYear: pd.year,
        pbMonth: pd.month,
        pbDay: pd.day || 1,
        gregorianDate: (pd.gregorianDate || pbToGregorian(pd.year, pd.month, pd.day || 1)).toISOString(),
      });
      
      input.value = '';
      render();
    }

    // Global Error Handler
    window.onerror = function(msg, url, line, col, error) {
      console.error("Global Error:", msg, error);
      // alert("Error: " + msg + "\nLine: " + line); // Uncomment for aggressive debugging
    };

    // ===== INIT =====
    async function init() {
      // 1. Initialize DB and Data (Non-blocking failure)
      try {
        await initDB();
        await loadSettings();
        await loadEvents();
      } catch (error) {
        console.error('Database/Data initialization failed (continuing with defaults):', error);
      }

      // 2. Initialize State
      try {
        if (!state.selectedDate) {
          state.selectedDate = gregorianToPB(new Date());
        }
      } catch (e) {
        console.error('Failed to calculate initial date:', e);
        // Fallback to a safe default if calculation fails
        state.selectedDate = { year: 7530, month: 1, day: 1, isEni: false, isBehti: false, gregorianDate: new Date() };
      }
      
      // 3. Setup UI (Always run)
      try {
        setupEventListeners();
        render();
        
        if (state.settings && !state.settings.tutorialDone) {
          showTutorial();
        }
      } catch (e) {
        console.error('UI Initialization failed:', e);
        alert('Critical Error: ' + e.message);
      }
    }

    // Make openEventModal global for onclick handlers
    window.openEventModal = openEventModal;

    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW registration failed:', err));
    }

    // Start the app
    init();
  </script>
</body>
</html>