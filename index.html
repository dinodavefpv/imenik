<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <title>–ò–º–µ–Ω–Ω–∏–∫ - Proto-Bulgarian Calendar</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#8B4513">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="–ò–º–µ–Ω–Ω–∏–∫">
  <meta name="description" content="Proto-Bulgarian Calendar with dual calendar system and event tracking">
  
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%238B4513'/><text x='50' y='65' text-anchor='middle' font-size='40' fill='white'>‚òÄ</text></svg>">
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Spectral:wght@400;500;600&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
  
  <style>
    /* ===== CSS RESET ===== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 16px; -webkit-font-smoothing: antialiased; }
    body { min-height: 100vh; line-height: 1.5; }
    button { font-family: inherit; cursor: pointer; border: none; background: none; }
    input, textarea, select { font-family: inherit; font-size: inherit; }

    /* ===== CSS VARIABLES ===== */
    :root {
      --font-display: 'Cormorant Garamond', Georgia, serif;
      --font-body: 'Spectral', Georgia, serif;
      --color-bg-primary: #F5EDE0;
      --color-bg-secondary: #EBE1D0;
      --color-bg-tertiary: #E0D5C1;
      --color-bg-card: #FAF6EF;
      --color-text-primary: #2D2419;
      --color-text-secondary: #5C4F3D;
      --color-text-tertiary: #8B7D65;
      --color-text-inverse: #FAF6EF;
      --color-accent-primary: #8B4513;
      --color-accent-secondary: #B8860B;
      --color-border: #C9B896;
      --color-special-eni: #7B2D26;
      --color-special-behti: #2E5A4C;
      --color-error: #9B2335;
      --shadow-sm: 0 1px 2px rgba(45, 36, 25, 0.08);
      --shadow-md: 0 4px 6px rgba(45, 36, 25, 0.1);
      --shadow-lg: 0 10px 15px rgba(45, 36, 25, 0.15);
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 20px;
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;
      --transition-fast: 150ms ease;
      --transition-normal: 250ms ease;
    }

    /* Dark mode */
    [data-mode="dark"] {
      --color-bg-primary: #1A1612;
      --color-bg-secondary: #252018;
      --color-bg-tertiary: #302A20;
      --color-bg-card: #1F1A14;
      --color-text-primary: #E8E0D4;
      --color-text-secondary: #B8A890;
      --color-text-tertiary: #8B7D65;
      --color-text-inverse: #1A1612;
      --color-accent-primary: #CD853F;
      --color-accent-secondary: #DAA520;
      --color-border: #4A3F2F;
      --color-special-eni: #C75050;
      --color-special-behti: #4CAF78;
    }

    /* Modern theme */
    [data-theme="modern"] {
      --font-display: 'Source Sans 3', system-ui, sans-serif;
      --font-body: 'Source Sans 3', system-ui, sans-serif;
      --color-bg-primary: #FFFFFF;
      --color-bg-secondary: #F8F9FA;
      --color-bg-tertiary: #F1F3F4;
      --color-bg-card: #FFFFFF;
      --color-text-primary: #1A1A1A;
      --color-text-secondary: #4A4A4A;
      --color-text-tertiary: #7A7A7A;
      --color-text-inverse: #FFFFFF;
      --color-accent-primary: #2563EB;
      --color-accent-secondary: #3B82F6;
      --color-border: #E5E7EB;
      --color-special-eni: #DC2626;
      --color-special-behti: #059669;
    }

    [data-theme="modern"][data-mode="dark"] {
      --color-bg-primary: #0F0F0F;
      --color-bg-secondary: #1A1A1A;
      --color-bg-tertiary: #262626;
      --color-bg-card: #1A1A1A;
      --color-text-primary: #F5F5F5;
      --color-text-secondary: #A3A3A3;
      --color-text-tertiary: #737373;
      --color-text-inverse: #0F0F0F;
      --color-accent-primary: #3B82F6;
      --color-border: #2A2A2A;
    }

    /* ===== BASE STYLES ===== */
    body {
      font-family: var(--font-body);
      background-color: var(--color-bg-primary);
      color: var(--color-text-primary);
      transition: background-color var(--transition-normal), color var(--transition-normal);
    }

    .app-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* ===== HEADER ===== */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-md);
      background: linear-gradient(to bottom, var(--color-bg-secondary), var(--color-bg-tertiary));
      border-bottom: 2px solid var(--color-border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-title {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
    }

    .header-year {
      font-family: var(--font-display);
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--color-accent-primary);
    }

    .header-animal {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }

    .header-element {
      font-size: 0.75rem;
      color: var(--color-text-tertiary);
    }

    .nav-button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      border-radius: var(--radius-md);
      color: var(--color-text-secondary);
      font-size: 1.5rem;
      transition: all var(--transition-fast);
    }

    .nav-button:hover {
      background-color: var(--color-bg-tertiary);
      color: var(--color-text-primary);
    }

    /* ===== MAIN CONTENT ===== */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: var(--space-md);
      padding-bottom: calc(var(--space-xl) + 70px);
    }

    /* ===== VIEW SWITCHER ===== */
    .view-switcher {
      display: flex;
      gap: var(--space-xs);
      padding: var(--space-sm);
      background-color: var(--color-bg-secondary);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-md);
    }

    .view-switch-btn {
      flex: 1;
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-secondary);
      transition: all var(--transition-fast);
    }

    .view-switch-btn.active {
      background-color: var(--color-accent-primary);
      color: var(--color-text-inverse);
    }

    .view-switch-btn:not(.active):hover {
      background-color: var(--color-bg-tertiary);
    }

    /* ===== QUICK ADD ===== */
    .quick-add-bar {
      display: flex;
      gap: var(--space-sm);
      padding: var(--space-sm);
      background-color: var(--color-bg-card);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-md);
      border: 1px solid var(--color-border);
    }

    .quick-add-input {
      flex: 1;
      padding: var(--space-sm) var(--space-md);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background-color: var(--color-bg-primary);
      color: var(--color-text-primary);
      font-size: 0.875rem;
    }

    .quick-add-input:focus {
      outline: none;
      border-color: var(--color-accent-primary);
    }

    /* ===== CALENDAR ===== */
    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-md);
    }

    .calendar-month-title {
      font-family: var(--font-display);
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .weekday-header {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      margin-bottom: var(--space-xs);
    }

    .weekday-cell {
      text-align: center;
      padding: var(--space-sm);
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--color-text-tertiary);
      text-transform: uppercase;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--space-xs);
      background-color: var(--color-bg-card);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
      position: relative;
      font-family: var(--font-display);
      font-weight: 600;
    }

    .calendar-day:hover { background-color: var(--color-bg-tertiary); }
    .calendar-day.today { background-color: var(--color-accent-primary); color: var(--color-text-inverse); }
    .calendar-day.selected { outline: 2px solid var(--color-accent-primary); outline-offset: -2px; }
    .calendar-day.empty { background: transparent; cursor: default; }
    .calendar-day.eni { background: linear-gradient(135deg, var(--color-special-eni), #a33); color: var(--color-text-inverse); }
    .calendar-day.behti { background: linear-gradient(135deg, var(--color-special-behti), #3a8); color: var(--color-text-inverse); }

    .day-gregorian {
      font-size: 0.5rem;
      opacity: 0.7;
      font-weight: 400;
    }

    .event-dot {
      position: absolute;
      bottom: 4px;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background-color: var(--color-accent-secondary);
    }

    /* ===== YEAR VIEW ===== */
    .year-view {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-md);
    }

    @media (max-width: 480px) {
      .year-view { grid-template-columns: repeat(2, 1fr); }
    }

    .year-month-card {
      background-color: var(--color-bg-card);
      border-radius: var(--radius-md);
      padding: var(--space-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
      border: 1px solid var(--color-border);
    }

    .year-month-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .year-month-card.current { border-color: var(--color-accent-primary); border-width: 2px; }

    .year-month-title {
      font-family: var(--font-display);
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: var(--space-xs);
    }

    .year-month-mini-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      font-size: 0.5rem;
    }

    .mini-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-tertiary);
    }

    .mini-day.today {
      background-color: var(--color-accent-primary);
      color: var(--color-text-inverse);
      border-radius: 50%;
    }

    /* ===== WEEK VIEW ===== */
    .week-view { display: flex; flex-direction: column; gap: var(--space-sm); }

    .week-day-row {
      display: flex;
      gap: var(--space-md);
      padding: var(--space-md);
      background-color: var(--color-bg-card);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
      border: 1px solid var(--color-border);
    }

    .week-day-row:hover { background-color: var(--color-bg-tertiary); }
    .week-day-row.today { border-left: 4px solid var(--color-accent-primary); }

    .week-day-date {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 50px;
    }

    .week-day-name {
      font-size: 0.75rem;
      color: var(--color-text-tertiary);
      text-transform: uppercase;
    }

    .week-day-number {
      font-family: var(--font-display);
      font-size: 1.5rem;
      font-weight: 600;
    }

    .week-day-events { flex: 1; }

    /* ===== DAY VIEW ===== */
    .day-view { display: flex; flex-direction: column; gap: var(--space-md); }

    .day-header {
      text-align: center;
      padding: var(--space-lg);
      background-color: var(--color-bg-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-border);
    }

    .day-header-date {
      font-family: var(--font-display);
      font-size: 3rem;
      font-weight: 700;
      color: var(--color-accent-primary);
    }

    .day-header-month { font-size: 1.25rem; color: var(--color-text-secondary); }
    .day-header-gregorian { font-size: 0.875rem; color: var(--color-text-tertiary); margin-top: var(--space-xs); }

    /* ===== EVENTS ===== */
    .event-card {
      display: flex;
      align-items: flex-start;
      gap: var(--space-md);
      padding: var(--space-md);
      background-color: var(--color-bg-card);
      border-radius: var(--radius-md);
      border-left: 4px solid var(--color-accent-secondary);
      cursor: pointer;
      transition: all var(--transition-fast);
      margin-bottom: var(--space-sm);
    }

    .event-card:hover { background-color: var(--color-bg-tertiary); }
    .event-title { font-weight: 500; }
    .event-time { font-size: 0.875rem; color: var(--color-text-tertiary); min-width: 50px; }
    .event-description { font-size: 0.875rem; color: var(--color-text-secondary); }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--space-xl);
      color: var(--color-text-tertiary);
      font-size: 0.875rem;
    }

    /* ===== BOTTOM NAV ===== */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: var(--space-sm) var(--space-md);
      padding-bottom: calc(var(--space-sm) + env(safe-area-inset-bottom, 0px));
      background: linear-gradient(to top, var(--color-bg-secondary), var(--color-bg-tertiary));
      border-top: 2px solid var(--color-border);
      z-index: 100;
    }

    .bottom-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      padding: var(--space-xs) var(--space-sm);
      border-radius: var(--radius-md);
      color: var(--color-text-tertiary);
      font-size: 0.625rem;
      text-transform: uppercase;
      transition: all var(--transition-fast);
    }

    .bottom-nav-item.active { color: var(--color-accent-primary); }
    .bottom-nav-item:hover { color: var(--color-text-primary); background-color: var(--color-bg-tertiary); }
    .bottom-nav-item span.icon { font-size: 1.5rem; }

    /* ===== FAB ===== */
    .fab {
      position: fixed;
      bottom: calc(80px + env(safe-area-inset-bottom, 0px));
      right: var(--space-md);
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background-color: var(--color-accent-primary);
      color: var(--color-text-inverse);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      box-shadow: var(--shadow-lg);
      z-index: 50;
      transition: all var(--transition-fast);
    }

    .fab:hover { transform: scale(1.05); }
    .fab:active { transform: scale(0.95); }

    /* ===== MODALS ===== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 150ms ease;
    }

    .modal-overlay.hidden { display: none; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    .modal-content {
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      background-color: var(--color-bg-primary);
      border-radius: var(--radius-xl) var(--radius-xl) 0 0;
      overflow: hidden;
      animation: slideUp 250ms ease;
    }

    @media (min-width: 768px) {
      .modal-overlay { align-items: center; }
      .modal-content { border-radius: var(--radius-xl); max-height: 80vh; }
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-md);
      border-bottom: 1px solid var(--color-border);
    }

    .modal-title {
      font-family: var(--font-display);
      font-size: 1.25rem;
      font-weight: 600;
    }

    .modal-body {
      padding: var(--space-md);
      overflow-y: auto;
      max-height: calc(90vh - 140px);
    }

    .modal-footer {
      display: flex;
      gap: var(--space-sm);
      padding: var(--space-md);
      border-top: 1px solid var(--color-border);
    }

    /* ===== FORM ===== */
    .form-group { margin-bottom: var(--space-md); }

    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-xs);
    }

    .form-input, .form-textarea, .form-select {
      width: 100%;
      padding: var(--space-sm) var(--space-md);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background-color: var(--color-bg-card);
      color: var(--color-text-primary);
      font-size: 1rem;
    }

    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: var(--color-accent-primary);
    }

    .form-textarea { min-height: 80px; resize: vertical; }
    .form-row { display: flex; gap: var(--space-sm); }
    .form-row > * { flex: 1; }

    /* ===== BUTTONS ===== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-md);
      font-weight: 500;
      font-size: 0.875rem;
      transition: all var(--transition-fast);
      flex: 1;
    }

    .btn-primary { background-color: var(--color-accent-primary); color: var(--color-text-inverse); }
    .btn-primary:hover { opacity: 0.9; }
    .btn-secondary { background-color: var(--color-bg-tertiary); color: var(--color-text-primary); }
    .btn-secondary:hover { background-color: var(--color-border); }
    .btn-danger { background-color: var(--color-error); color: white; }
    .btn-icon { padding: var(--space-sm); flex: 0; }

    /* ===== SETTINGS ===== */
    .settings-section { margin-bottom: var(--space-xl); }

    .settings-section-title {
      font-family: var(--font-display);
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--color-text-tertiary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: var(--space-md);
    }

    .settings-option {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-md);
      background-color: var(--color-bg-card);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-xs);
      border: 1px solid var(--color-border);
    }

    .settings-option-title { font-weight: 500; }
    .settings-option-desc { font-size: 0.75rem; color: var(--color-text-tertiary); }

    .toggle-switch {
      position: relative;
      width: 48px;
      height: 28px;
      background-color: var(--color-bg-tertiary);
      border-radius: 14px;
      cursor: pointer;
      transition: background-color var(--transition-fast);
    }

    .toggle-switch.active { background-color: var(--color-accent-primary); }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 24px;
      height: 24px;
      background-color: white;
      border-radius: 50%;
      transition: transform var(--transition-fast);
      box-shadow: var(--shadow-sm);
    }

    .toggle-switch.active::after { transform: translateX(20px); }

    /* ===== TUTORIAL ===== */
    .tutorial-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--color-bg-primary);
      z-index: 2000;
      display: flex;
      flex-direction: column;
    }

    .tutorial-overlay.hidden { display: none; }

    .tutorial-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--space-xl);
      text-align: center;
    }

    .tutorial-icon { font-size: 5rem; margin-bottom: var(--space-xl); }

    .tutorial-title {
      font-family: var(--font-display);
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: var(--space-md);
      color: var(--color-accent-primary);
    }

    .tutorial-description {
      font-size: 1rem;
      color: var(--color-text-secondary);
      max-width: 320px;
      line-height: 1.6;
    }

    .tutorial-dots {
      display: flex;
      gap: var(--space-sm);
      margin: var(--space-xl) 0;
    }

    .tutorial-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: var(--color-border);
      transition: all var(--transition-fast);
    }

    .tutorial-dot.active {
      width: 24px;
      border-radius: 4px;
      background-color: var(--color-accent-primary);
    }

    .tutorial-footer {
      display: flex;
      justify-content: space-between;
      padding: var(--space-md) var(--space-xl);
      padding-bottom: calc(var(--space-md) + env(safe-area-inset-bottom, 0px));
    }

    .tutorial-skip { color: var(--color-text-tertiary); font-size: 0.875rem; }

    /* ===== LOADING ===== */
    .loading { display: flex; align-items: center; justify-content: center; padding: var(--space-xl); }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--color-border);
      border-top-color: var(--color-accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Hide pages */
    .page { display: none; }
    .page.active { display: block; }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Tutorial Overlay -->
    <div id="tutorial" class="tutorial-overlay hidden">
      <div class="tutorial-content">
        <div class="tutorial-icon" id="tutorial-icon">üìú</div>
        <h1 class="tutorial-title" id="tutorial-title">–î–æ–±—Ä–µ –¥–æ—à–ª–∏ –≤ –ò–º–µ–Ω–Ω–∏–∫</h1>
        <p class="tutorial-description" id="tutorial-desc">–û—Ç–∫—Ä–∏–π—Ç–µ –¥—Ä–µ–≤–Ω–∏—è –ø—Ä–∞–±—ä–ª–≥–∞—Ä—Å–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä - –µ–¥–Ω–∞ –æ—Ç –Ω–∞–π-—Ç–æ—á–Ω–∏—Ç–µ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–∏ —Å–∏—Å—Ç–µ–º–∏ –≤ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞.</p>
        <div class="tutorial-dots" id="tutorial-dots"></div>
      </div>
      <div class="tutorial-footer">
        <button class="tutorial-skip" id="tutorial-skip">–ü—Ä–æ–ø—É—Å–Ω–∏</button>
        <button class="btn btn-primary" id="tutorial-next">–ù–∞–ø—Ä–µ–¥</button>
      </div>
    </div>

    <!-- Header -->
    <header class="header">
      <button class="nav-button" id="menu-btn">‚ò∞</button>
      <div class="header-title">
        <div class="header-year" id="header-year">–ì–æ–¥–∏–Ω–∞ –Ω–∞ –ó–º–∏—è—Ç–∞ 7531</div>
        <div class="header-element" id="header-element">–î—ä—Ä–≤–æ ‚Ä¢ –ñ–µ–Ω—Å–∫–∏</div>
      </div>
      <div id="header-animal" style="font-size: 1.75rem;">üêç</div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Calendar Page -->
      <div id="page-calendar" class="page active">
        <div class="view-switcher">
          <button class="view-switch-btn active" data-view="month">–ú–µ—Å–µ—Ü</button>
          <button class="view-switch-btn" data-view="week">–°–µ–¥–º–∏—Ü–∞</button>
          <button class="view-switch-btn" data-view="day">–î–µ–Ω</button>
          <button class="view-switch-btn" data-view="year">–ì–æ–¥–∏–Ω–∞</button>
        </div>

        <div class="quick-add-bar">
          <input type="text" class="quick-add-input" id="quick-add-input" placeholder="–ë—ä—Ä–∑–æ –¥–æ–±–∞–≤—è–Ω–µ –Ω–∞ —Å—ä–±–∏—Ç–∏–µ...">
          <button class="btn btn-primary btn-icon" id="quick-add-btn">+</button>
        </div>

        <!-- Month View -->
        <div id="view-month" class="view">
          <div class="calendar-header">
            <button class="nav-button" id="prev-month">‚óÄ</button>
            <h2 class="calendar-month-title" id="month-title">–ê–õ–ï–ú 7531</h2>
            <button class="nav-button" id="next-month">‚ñ∂</button>
          </div>
          <div class="weekday-header" id="weekday-header"></div>
          <div class="calendar-grid" id="calendar-grid"></div>
        </div>

        <!-- Week View -->
        <div id="view-week" class="view" style="display:none;">
          <div class="calendar-header">
            <button class="nav-button" id="prev-week">‚óÄ</button>
            <h2 class="calendar-month-title" id="week-title">–°–µ–¥–º–∏—Ü–∞</h2>
            <button class="nav-button" id="next-week">‚ñ∂</button>
          </div>
          <div class="week-view" id="week-grid"></div>
        </div>

        <!-- Day View -->
        <div id="view-day" class="view" style="display:none;">
          <div class="calendar-header">
            <button class="nav-button" id="prev-day">‚óÄ</button>
            <span style="flex:1"></span>
            <button class="nav-button" id="next-day">‚ñ∂</button>
          </div>
          <div class="day-view">
            <div class="day-header">
              <div class="day-header-date" id="day-date">15</div>
              <div class="day-header-month" id="day-month">–ê–õ–ï–ú</div>
              <div class="day-header-gregorian" id="day-gregorian">22/12/2024</div>
            </div>
            <div id="day-events"></div>
          </div>
        </div>

        <!-- Year View -->
        <div id="view-year" class="view" style="display:none;">
          <div class="calendar-header">
            <button class="nav-button" id="prev-year">‚óÄ</button>
            <h2 class="calendar-month-title" id="year-title">7531</h2>
            <button class="nav-button" id="next-year">‚ñ∂</button>
          </div>
          <div class="year-view" id="year-grid"></div>
        </div>
      </div>

      <!-- Settings Page -->
      <div id="page-settings" class="page">
        <div class="settings-section">
          <h3 class="settings-section-title">–ò–∑–≥–ª–µ–¥</h3>
          <div class="settings-option">
            <div><div class="settings-option-title">–¢–µ–º–∞</div><div class="settings-option-desc" id="theme-desc">–¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∞</div></div>
            <button class="toggle-switch active" id="toggle-theme"></button>
          </div>
          <div class="settings-option">
            <div><div class="settings-option-title">–†–µ–∂–∏–º</div><div class="settings-option-desc" id="mode-desc">–°–≤–µ—Ç—ä–ª</div></div>
            <button class="toggle-switch" id="toggle-mode"></button>
          </div>
        </div>
        <div class="settings-section">
          <h3 class="settings-section-title">–ï–∑–∏–∫</h3>
          <div class="settings-option">
            <div><div class="settings-option-title">–ï–∑–∏–∫</div><div class="settings-option-desc" id="lang-desc">–ë—ä–ª–≥–∞—Ä—Å–∫–∏</div></div>
            <button class="toggle-switch active" id="toggle-lang"></button>
          </div>
          <div class="settings-option">
            <div><div class="settings-option-title">–¢–µ—Ä–º–∏–Ω–∏</div><div class="settings-option-desc" id="terms-desc">–ü—Ä–∞–±—ä–ª–≥–∞—Ä—Å–∫–∏</div></div>
            <button class="toggle-switch active" id="toggle-terms"></button>
          </div>
        </div>
        <div class="settings-section">
          <h3 class="settings-section-title">–ö–∞–ª–µ–Ω–¥–∞—Ä</h3>
          <div class="settings-option">
            <div><div class="settings-option-title">–ù–∞—á–∞–ª–æ –Ω–∞ —Å–µ–¥–º–∏—Ü–∞—Ç–∞</div><div class="settings-option-desc" id="week-start-desc">–ü–æ–Ω–µ–¥–µ–ª–Ω–∏–∫</div></div>
            <button class="toggle-switch active" id="toggle-week-start"></button>
          </div>
          <div class="settings-option">
            <div><div class="settings-option-title">–ü–æ–∫–∞–∑–≤–∞–π –≥—Ä–∏–≥–æ—Ä–∏–∞–Ω—Å–∫–∏</div></div>
            <button class="toggle-switch" id="toggle-gregorian"></button>
          </div>
        </div>
        <div class="settings-section">
          <h3 class="settings-section-title">–î–∞–Ω–Ω–∏</h3>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-secondary" id="export-btn">üì• –ï–∫—Å–ø–æ—Ä—Ç ICS</button>
            <button class="btn btn-secondary" id="import-btn">üì§ –ò–º–ø–æ—Ä—Ç ICS</button>
          </div>
          <input type="file" id="import-file" accept=".ics" style="display:none">
        </div>
        <div class="settings-section">
          <button class="btn btn-secondary" id="tutorial-btn" style="width:100%">üìñ –ü–æ–≤—Ç–æ—Ä–∏ —É—Ä–æ–∫–∞</button>
        </div>
      </div>
    </main>

    <!-- FAB -->
    <button class="fab" id="fab">+</button>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
      <button class="bottom-nav-item active" data-page="calendar">
        <span class="icon">üìÖ</span>
        <span>–ö–∞–ª–µ–Ω–¥–∞—Ä</span>
      </button>
      <button class="bottom-nav-item" id="today-btn">
        <span class="icon">‚äô</span>
        <span>–î–Ω–µ—Å</span>
      </button>
      <button class="bottom-nav-item" data-page="settings">
        <span class="icon">‚öô</span>
        <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
      </button>
    </nav>

    <!-- Event Modal -->
    <div class="modal-overlay hidden" id="event-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="modal-title">–î–æ–±–∞–≤–∏ —Å—ä–±–∏—Ç–∏–µ</h2>
          <button class="nav-button" id="modal-close">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">–ó–∞–≥–ª–∞–≤–∏–µ</label>
            <input type="text" class="form-input" id="event-title" placeholder="–ó–∞–≥–ª–∞–≤–∏–µ –Ω–∞ —Å—ä–±–∏—Ç–∏–µ—Ç–æ">
          </div>
          <div class="form-group">
            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea class="form-textarea" id="event-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">–î–∞—Ç–∞</label>
            <div class="form-row">
              <select class="form-select" id="event-year"></select>
              <select class="form-select" id="event-month"></select>
              <select class="form-select" id="event-day"></select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">–ß–∞—Å (–ø–æ –∏–∑–±–æ—Ä)</label>
            <div class="form-row">
              <select class="form-select" id="event-hour">
                <option value="">--</option>
              </select>
              <select class="form-select" id="event-minute">
                <option value="">--</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</label>
            <select class="form-select" id="event-recurrence">
              <option value="none">–ù—è–º–∞</option>
              <option value="daily">–î–Ω–µ–≤–Ω–æ</option>
              <option value="weekly">–°–µ–¥–º–∏—á–Ω–æ</option>
              <option value="monthly">–ú–µ—Å–µ—á–Ω–æ</option>
              <option value="yearly">–ì–æ–¥–∏—à–Ω–æ</option>
              <option value="animal">–ù–∞ 12 –≥–æ–¥–∏–Ω–∏ (–∂–∏–≤–æ—Ç–∏–Ω—Å–∫–∏ —Ü–∏–∫—ä–ª)</option>
              <option value="starday">–ù–∞ 60 –≥–æ–¥–∏–Ω–∏ (–∑–≤–µ–∑–¥–µ–Ω –¥–µ–Ω)</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger btn-icon" id="event-delete" style="display:none">üóë</button>
          <button class="btn btn-secondary" id="event-cancel">–û—Ç–∫–∞–∑</button>
          <button class="btn btn-primary" id="event-save">–ó–∞–ø–∞–∑–∏</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== PROTO-BULGARIAN CALENDAR ENGINE =====
    // Epoch: 5505 BC (counting back). 
    // Current year calculation: (Gregorian Year + 5505).
    // Note: The calendar starts on Winter Solstice. 
    // The PB year effectively covers the *following* Gregorian year.
    // e.g., Dec 2024 starts PB year 7530 (which corresponds to 2025).
    const EPOCH_OFFSET = 5505; 
    
    const ANIMALS = [
      { id: 0, proto: '–î–û–ö–°', bg: '–ü—Ä–∞—Å–µ', en: 'Pig', emoji: 'üê∑', color: '#C4A4A4' },
      { id: 1, proto: '–°–û–ú–û–†', bg: '–ú–∏—à–∫–∞', en: 'Mouse', emoji: 'üê≠', color: '#A8A8B8' },
      { id: 2, proto: '–®–ï–ì–û–†', bg: '–í–æ–ª', en: 'Bull', emoji: 'üêÇ', color: '#8B6914' },
      { id: 3, proto: '–ë–ê–†–°', bg: '–ë–∞—Ä—Å', en: 'Tiger', emoji: 'üêØ', color: '#D4842A' },
      { id: 4, proto: '–î–í–ê–ù', bg: '–ó–∞–µ–∫', en: 'Rabbit', emoji: 'üê∞', color: '#E8DCC8' },
      { id: 5, proto: '–í–ï–†–ï–ù–ò', bg: '–î—Ä–∞–∫–æ–Ω', en: 'Dragon', emoji: 'üêâ', color: '#2E8B57' },
      { id: 6, proto: '–î–ò–õ–û–ú', bg: '–ó–º–∏—è', en: 'Snake', emoji: 'üêç', color: '#6B3FA0' },
      { id: 7, proto: '–¢–ï|–ö–£', bg: '–ö–æ–Ω', en: 'Horse', emoji: 'üê¥', color: '#8B4513' },
      { id: 8, proto: '–ü–ò–°–ò–ù', bg: '–ú–∞–π–º—É–Ω–∞', en: 'Monkey', emoji: 'üêµ', color: '#DAA520' },
      { id: 9, proto: '–°–£–†–ê–•', bg: '–û–≤–µ–Ω', en: 'Ram', emoji: 'üêè', color: '#FFFFF0' },
      { id: 10, proto: '–¢–û–•', bg: '–ü–µ—Ç–µ–ª', en: 'Rooster', emoji: 'üêì', color: '#DC143C' },
      { id: 11, proto: '–ï–¢–•', bg: '–ö—É—á–µ', en: 'Dog', emoji: 'üêï', color: '#C4A484' },
    ];

    const ELEMENTS = [
      { id: 0, proto: '–í–û–î–ê', bg: '–í–æ–¥–∞', en: 'Water', color: '#4A90D9' },
      { id: 1, proto: '–û–ì–™–ù', bg: '–û–≥—ä–Ω', en: 'Fire', color: '#E85D04' },
      { id: 2, proto: '–ó–ï–ú–Ø', bg: '–ó–µ–º—è', en: 'Earth', color: '#8B7355' },
      { id: 3, proto: '–î–™–†–í–û', bg: '–î—ä—Ä–≤–æ', en: 'Tree', color: '#228B22' },
      { id: 4, proto: '–ú–ï–¢–ê–õ', bg: '–ú–µ—Ç–∞–ª', en: 'Metal', color: '#71797E' },
    ];

    const GENDERS = [
      { proto: '–ú–™–ñ–ö–ò', bg: '–ú—ä–∂–∫–∏', en: 'Male' },
      { proto: '–ñ–ï–ù–°–ö–ò', bg: '–ñ–µ–Ω—Å–∫–∏', en: 'Female' },
    ];

    const MONTHS = [
      { id: 1, proto: '–ê–õ–ï–ú', bg: '–ü—ä—Ä–≤–∏', en: 'First', days: 31 },
      { id: 2, proto: '–¢–£–¢–û–ú', bg: '–í—Ç–æ—Ä–∏', en: 'Second', days: 30 },
      { id: 3, proto: '–ß–ò–¢–ï–ú', bg: '–¢—Ä–µ—Ç–∏', en: 'Third', days: 30 },
      { id: 4, proto: '–¢–í–ò–†–ï–ú', bg: '–ß–µ—Ç–≤—ä—Ä—Ç–∏', en: 'Fourth', days: 31 },
      { id: 5, proto: '–í–ï–ß–ï–ú', bg: '–ü–µ—Ç–∏', en: 'Fifth', days: 30 },
      { id: 6, proto: '–®–ï–•–¢–ï–ú', bg: '–®–µ—Å—Ç–∏', en: 'Sixth', days: 30 },
      { id: 7, proto: '–°–ï–¢–ï–ú', bg: '–°–µ–¥–º–∏', en: 'Seventh', days: 31 },
      { id: 8, proto: '–û–°–ï–ú', bg: '–û—Å–º–∏', en: 'Eighth', days: 30 },
      { id: 9, proto: '–î–ï–í–ï–ú', bg: '–î–µ–≤–µ—Ç–∏', en: 'Ninth', days: 30 },
      { id: 10, proto: '–ï–õ–ï–ú', bg: '–î–µ—Å–µ—Ç–∏', en: 'Tenth', days: 31 },
      { id: 11, proto: '–ï–ù–ò–ê–õ–ï–ú', bg: '–ï–¥–∏–Ω–∞–¥–µ—Å–µ—Ç–∏', en: 'Eleventh', days: 30 },
      { id: 12, proto: '–ê–õ–¢–ï–ú', bg: '–î–≤–∞–Ω–∞–¥–µ—Å–µ—Ç–∏', en: 'Twelfth', days: 30 },
    ];

    // Special definitions for Eni and Behti for display purposes
    const DAY_ENI = { id: 0, proto: '–ï–ù–ò', bg: '–ï–Ω–∏ (–ò–≥–Ω–∞–∂–¥–µ–Ω)', en: 'Eni (Ignazhden)', days: 1, isSpecial: true };
    const DAY_BEHTI = { id: 13, proto: '–ë–ï–•–¢–ò', bg: '–ë–µ—Ö—Ç–∏', en: 'Behti', days: 1, isSpecial: true };

    const WEEKDAYS = [
      { proto: '–ù–ï–î', bg: '–ù–¥', en: 'Su' },
      { proto: '–ü–û–ù', bg: '–ü–Ω', en: 'Mo' },
      { proto: '–í–¢–û', bg: '–í—Ç', en: 'Tu' },
      { proto: '–°–†–Ø', bg: '–°—Ä', en: 'We' },
      { proto: '–ß–ï–¢', bg: '–ß—Ç', en: 'Th' },
      { proto: '–ü–ï–¢', bg: '–ü—Ç', en: 'Fr' },
      { proto: '–°–™–ë', bg: '–°–±', en: 'Sa' },
    ];

    const TUTORIAL_SLIDES = [
      { icon: 'üìú', title: '–î–æ–±—Ä–µ –¥–æ—à–ª–∏ –≤ –ò–º–µ–Ω–Ω–∏–∫', desc: '–û—Ç–∫—Ä–∏–π—Ç–µ –¥—Ä–µ–≤–Ω–∏—è –ø—Ä–∞–±—ä–ª–≥–∞—Ä—Å–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä - –µ–¥–Ω–∞ –æ—Ç –Ω–∞–π-—Ç–æ—á–Ω–∏—Ç–µ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–∏ —Å–∏—Å—Ç–µ–º–∏ –≤ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞.' },
      { icon: 'üêâ', title: '12-–≥–æ–¥–∏—à–µ–Ω —Ü–∏–∫—ä–ª', desc: '–í—Å—è–∫–∞ –≥–æ–¥–∏–Ω–∞ –µ –Ω–∞—Ä–µ—á–µ–Ω–∞ –Ω–∞ –µ–¥–Ω–æ –æ—Ç 12 –∂–∏–≤–æ—Ç–Ω–∏: –ü—Ä–∞—Å–µ, –ú–∏—à–∫–∞, –í–æ–ª, –ë–∞—Ä—Å, –ó–∞–µ–∫, –î—Ä–∞–∫–æ–Ω, –ó–º–∏—è, –ö–æ–Ω, –ú–∞–π–º—É–Ω–∞, –û–≤–µ–Ω, –ü–µ—Ç–µ–ª, –ö—É—á–µ.' },
      { icon: '‚ú®', title: '60-–≥–æ–¥–∏—à–µ–Ω –ó–≤–µ–∑–¥–µ–Ω –¥–µ–Ω', desc: '–ü–µ—Ç —Å—Ç–∏—Ö–∏–∏ —Å–µ —Ä–µ–¥—É–≤–∞—Ç: –í–æ–¥–∞, –û–≥—ä–Ω, –ó–µ–º—è, –î—ä—Ä–≤–æ, –ú–µ—Ç–∞–ª. –í—Å—è–∫–∞ —Å—Ç–∏—Ö–∏—è —É–ø—Ä–∞–≤–ª—è–≤–∞ 12 –≥–æ–¥–∏–Ω–∏.' },
      { icon: '‚òÄÔ∏è', title: '–ï–Ω–∏ - –ù–æ–≤–∞ –ì–æ–¥–∏–Ω–∞', desc: '–ù–æ–≤–∞—Ç–∞ –≥–æ–¥–∏–Ω–∞ –∑–∞–ø–æ—á–≤–∞ –Ω–∞ –∑–∏–º–Ω–æ—Ç–æ —Å–ª—ä–Ω—Ü–µ—Å—Ç–æ–µ–Ω–µ (~21-22 –¥–µ–∫–µ–º–≤—Ä–∏). –¢–æ–∑–∏ –¥–µ–Ω —Å–µ –Ω–∞—Ä–∏—á–∞ –ï–Ω–∏ –∏ –Ω–µ –µ —á–∞—Å—Ç –æ—Ç –º–µ—Å–µ—Ü–∏—Ç–µ.' },
    ];

    // ===== STATE =====
    let state = {
      settings: {
        theme: 'traditional',
        mode: 'light',
        lang: 'bg',
        useProto: true,
        weekStartsOn: 1,
        showGregorian: false,
        tutorialDone: false,
      },
      selectedDate: null,
      currentView: 'month',
      currentPage: 'calendar',
      events: [],
      editingEvent: null,
      tutorialSlide: 0,
    };

    // ===== CALENDAR FUNCTIONS =====
    
    // Check if a Gregorian year is a leap year
    function isLeapGregorian(year) {
      return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
    }

    // Check if PB year is leap. 
    // A PB year covers Jan-Dec of the *following* Gregorian year.
    // So if the following Gregorian year is leap, the PB year needs a leap day (Behti).
    function isPBYearLeap(pbYear) {
      // pbYear 7530 -> Gregorian 2025.
      // 7530 - 5505 = 2025.
      const gregYear = pbYear - EPOCH_OFFSET; 
      return isLeapGregorian(gregYear);
    }

    function getWinterSolstice(gYear) {
      // Simplified: Always Dec 21 for calculation base, 
      // though astronomically it varies. Standard PB calendar uses fixed point or simple rule.
      // Usually Eni is Dec 22 if previous year was leap? 
      // For this implementation, we anchor to Dec 21 as the START of Eni/Year.
      return new Date(gYear, 11, 21);
    }

    function getAnimalForYear(pbYear) {
      const asparuhYear = 6185;
      const asparuhAnimalIndex = 5;
      const yearDiff = pbYear - asparuhYear;
      const idx = ((yearDiff % 12) + 12 + asparuhAnimalIndex) % 12;
      return ANIMALS[idx];
    }

    function getElementForYear(pbYear) {
      const cyclePosition = ((pbYear - 1) % 60 + 60) % 60;
      return ELEMENTS[Math.floor(cyclePosition / 12)];
    }

    function getGenderForYear(pbYear) {
      const el = getElementForYear(pbYear);
      return el.id % 2 === 0 ? GENDERS[0] : GENDERS[1];
    }

    function gregorianToPB(date) {
      const d = new Date(date);
      d.setHours(0,0,0,0);
      const gYear = d.getFullYear();
      
      // Determine which PB year this date belongs to.
      // PB Year starts around Dec 21.
      let solsticeYear = gYear;
      let solstice = getWinterSolstice(solsticeYear);
      
      if (d < solstice) {
        solsticeYear = gYear - 1;
        solstice = getWinterSolstice(solsticeYear);
      }
      
      // PB Year number
      const pbYear = (solsticeYear + 1) + EPOCH_OFFSET; 
      
      // Calculate days since Solstice (Eni)
      const msPerDay = 24 * 60 * 60 * 1000;
      // Rounding to avoid DST issues
      let daysSinceSolstice = Math.round((d - solstice) / msPerDay);
      
      // Day 0 is Eni
      if (daysSinceSolstice === 0) {
        return { year: pbYear, month: 0, day: 1, isEni: true, isBehti: false, gregorianDate: d };
      }
      
      let remainingDays = daysSinceSolstice - 1; // Subtract Eni
      
      // Months 1-6
      for (let i = 0; i < 6; i++) {
        if (remainingDays < MONTHS[i].days) {
          return {
            year: pbYear,
            month: MONTHS[i].id,
            day: remainingDays + 1,
            isEni: false,
            isBehti: false,
            gregorianDate: d
          };
        }
        remainingDays -= MONTHS[i].days;
      }
      
      // Check Behti (after Month 6)
      // PB Year X corresponds to Gregorian Year X - 5505.
      // The leap day is in that Gregorian Year.
      if (isPBYearLeap(pbYear)) {
        if (remainingDays === 0) {
          return { year: pbYear, month: 13, day: 1, isEni: false, isBehti: true, gregorianDate: d };
        }
        remainingDays--; // Subtract Behti
      }
      
      // Months 7-12
      for (let i = 6; i < 12; i++) {
         if (remainingDays < MONTHS[i].days) {
          return {
            year: pbYear,
            month: MONTHS[i].id,
            day: remainingDays + 1,
            isEni: false,
            isBehti: false,
            gregorianDate: d
          };
        }
        remainingDays -= MONTHS[i].days;
      }
      
      // Fallback (should not happen usually, maybe end of year overlap?)
      return { year: pbYear + 1, month: 0, day: 1, isEni: true, isBehti: false, gregorianDate: d };
    }

    function pbToGregorian(pbYear, pbMonth, pbDay) {
      // pbYear 7530 -> solsticeYear 2024 (starts Dec 2024)
      const solsticeYear = pbYear - EPOCH_OFFSET - 1;
      const solstice = getWinterSolstice(solsticeYear);
      let daysToAdd = 0;
      
      if (pbMonth === 0) { // Eni
        daysToAdd = 0;
      } else {
        daysToAdd += 1; // Eni
        
        // Months before target
        // Handle Behti
        const targetMonthIndex = (pbMonth === 13) ? 6 : (pbMonth > 13 ? 12 : pbMonth - 1);
        // But wait, 13 is Behti.
        
        // Sum days
        // 1. Months 1 to (min(month-1, 6))
        const limit1 = (pbMonth === 13) ? 6 : Math.min(pbMonth - 1, 6);
        for (let i = 0; i < limit1; i++) daysToAdd += MONTHS[i].days;
        
        // 2. Behti
        if ((pbMonth === 13 || pbMonth > 6) && isPBYearLeap(pbYear)) {
             // If we are AT Behti (13), we don't add it yet (it's the current day calc below)
             // If we are AFTER Behti (Month 7+), we add it.
             if (pbMonth > 6 && pbMonth !== 13) daysToAdd += 1;
        }
        
        // 3. Months 7 to month-1
        if (pbMonth > 6 && pbMonth !== 13) {
          for (let i = 6; i < pbMonth - 1; i++) daysToAdd += MONTHS[i].days;
        }
        
        // 4. Current day
        daysToAdd += (pbDay - 1);
      }
      
      const result = new Date(solstice);
      result.setDate(result.getDate() + daysToAdd);
      result.setHours(0,0,0,0);
      return result;
    }

    function getMonthDays(pbYear, pbMonth) {
      if (pbMonth === 0) { // Eni
        return [{ pbDay: 1, pbMonth: 0, pbYear, gregorianDate: pbToGregorian(pbYear, 0, 1), isEni: true }];
      }
      if (pbMonth === 13) { // Behti
        return [{ pbDay: 1, pbMonth: 13, pbYear, gregorianDate: pbToGregorian(pbYear, 13, 1), isBehti: true }];
      }

      const monthIdx = pbMonth - 1;
      const month = MONTHS[monthIdx];
      if (!month) return [];
      
      const days = [];
      for (let day = 1; day <= month.days; day++) {
        const gregorian = pbToGregorian(pbYear, pbMonth, day);
        days.push({ pbDay: day, pbMonth, pbYear, gregorianDate: gregorian });
      }
      return days;
    }

    // Get the sequence of viewable entities for a year
    function getYearStructure(pbYear) {
      const struct = [0]; // Eni
      for(let i=1; i<=6; i++) struct.push(i);
      if (isPBYearLeap(pbYear)) struct.push(13); // Behti
      for(let i=7; i<=12; i++) struct.push(i);
      return struct;
    }

    function isSameDay(d1, d2) {
      if (!d1 || !d2) return false;
      return d1.year === d2.year && d1.month === d2.month && d1.day === d2.day;
    }

    // ===== LOCALIZATION =====
    function t(obj) {
      if (!obj) return '';
      if (state.settings.useProto && obj.proto) return obj.proto;
      return state.settings.lang === 'bg' ? (obj.bg || obj.en) : obj.en;
    }

    // ===== INDEXEDDB =====
    let db = null;
    
    async function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('imennik', 1);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => { db = request.result; resolve(db); };
        request.onupgradeneeded = (e) => {
          const database = e.target.result;
          if (!database.objectStoreNames.contains('events')) {
            database.createObjectStore('events', { keyPath: 'id' });
          }
          if (!database.objectStoreNames.contains('settings')) {
            database.createObjectStore('settings', { keyPath: 'key' });
          }
        };
      });
    }

    async function loadSettings() {
      return new Promise((resolve) => {
        const tx = db.transaction('settings', 'readonly');
        const store = tx.objectStore('settings');
        const request = store.get('settings');
        request.onsuccess = () => {
          if (request.result) {
            state.settings = { ...state.settings, ...request.result.value };
          }
          resolve();
        };
        request.onerror = () => resolve();
      });
    }

    async function saveSettings() {
      const tx = db.transaction('settings', 'readwrite');
      const store = tx.objectStore('settings');
      store.put({ key: 'settings', value: state.settings });
    }

    async function loadEvents() {
      return new Promise((resolve) => {
        const tx = db.transaction('events', 'readonly');
        const store = tx.objectStore('events');
        const request = store.getAll();
        request.onsuccess = () => {
          state.events = request.result || [];
          resolve();
        };
        request.onerror = () => resolve();
      });
    }

    async function saveEvent(event) {
      const tx = db.transaction('events', 'readwrite');
      const store = tx.objectStore('events');
      store.put(event);
      await loadEvents();
    }

    async function deleteEvent(id) {
      const tx = db.transaction('events', 'readwrite');
      const store = tx.objectStore('events');
      store.delete(id);
      await loadEvents();
    }

    // ===== UI RENDERING =====
    function applyTheme() {
      document.documentElement.setAttribute('data-theme', state.settings.theme);
      document.documentElement.setAttribute('data-mode', state.settings.mode);
    }

    function updateHeader() {
      const pd = state.selectedDate;
      const animal = getAnimalForYear(pd.year);
      const element = getElementForYear(pd.year);
      const gender = getGenderForYear(pd.year);
      
      const yearText = state.settings.lang === 'bg' ? '–ì–æ–¥–∏–Ω–∞ –Ω–∞' : 'Year of the';
      document.getElementById('header-year').textContent = `${yearText} ${t(animal)} ${pd.year}`;
      document.getElementById('header-element').textContent = `${t(element)} ‚Ä¢ ${t(gender)}`;
      document.getElementById('header-element').style.color = element.color;
      document.getElementById('header-animal').textContent = animal.emoji;
    }

    function renderWeekdayHeader() {
      const container = document.getElementById('weekday-header');
      container.innerHTML = '';
      
      let weekdays = [...WEEKDAYS];
      if (state.settings.weekStartsOn === 1) {
        weekdays = [...weekdays.slice(1), weekdays[0]];
      }
      
      weekdays.forEach(wd => {
        const cell = document.createElement('div');
        cell.className = 'weekday-cell';
        cell.textContent = t(wd);
        container.appendChild(cell);
      });
    }

    function getEventsForDate(pd) {
      return state.events.filter(e => 
        e.pbYear === pd.year && e.pbMonth === pd.month && e.pbDay === pd.day
      );
    }

    function getEntityName(id) {
        if (id === 0) return t(DAY_ENI);
        if (id === 13) return t(DAY_BEHTI);
        return t(MONTHS[id - 1]);
    }

    function renderMonthView() {
      const pd = state.selectedDate;
      const days = getMonthDays(pd.year, pd.month);
      
      const title = getEntityName(pd.month);
      document.getElementById('month-title').textContent = `${title} ${pd.year}`;
      
      // If Eni or Behti (single day special view)
      if (pd.month === 0 || pd.month === 13) {
          document.getElementById('weekday-header').style.display = 'none';
          const grid = document.getElementById('calendar-grid');
          grid.innerHTML = '';
          grid.style.display = 'flex';
          grid.style.justifyContent = 'center';
          grid.style.padding = '20px';

          const day = days[0];
          const cell = document.createElement('div');
          cell.className = `calendar-day ${pd.month === 0 ? 'eni' : 'behti'} selected`;
          cell.style.width = '100px';
          cell.style.height = '100px';
          cell.style.fontSize = '1.5rem';
          
          const events = getEventsForDate(pd);
          
          cell.innerHTML = `
            <span>${pd.month === 0 ? '‚ú¶' : '‚òÖ'}</span>
            ${state.settings.showGregorian ? `<span class="day-gregorian" style="font-size:0.8rem">${day.gregorianDate.getDate()}/${day.gregorianDate.getMonth()+1}</span>` : ''}
            ${events.length > 0 ? '<span class="event-dot"></span>' : ''}
          `;
           cell.addEventListener('click', () => {
             // Already selected
           });
           grid.appendChild(cell);
           return;
      }

      // Standard Month
      document.getElementById('weekday-header').style.display = 'grid';
      document.getElementById('calendar-grid').style.display = 'grid';
      document.getElementById('calendar-grid').style.justifyContent = 'initial';
      document.getElementById('calendar-grid').style.padding = '0';
      
      renderWeekdayHeader();
      
      const grid = document.getElementById('calendar-grid');
      grid.innerHTML = '';
      
      if (days.length === 0) return;
      
      const firstDayWeekday = days[0].gregorianDate.getDay();
      let startPadding = firstDayWeekday;
      if (state.settings.weekStartsOn === 1) {
        startPadding = firstDayWeekday === 0 ? 6 : firstDayWeekday - 1;
      }
      
      for (let i = 0; i < startPadding; i++) {
        const empty = document.createElement('div');
        empty.className = 'calendar-day empty';
        grid.appendChild(empty);
      }
      
      const today = gregorianToPB(new Date());
      
      days.forEach(day => {
        const cell = document.createElement('div');
        cell.className = 'calendar-day';
        
        const dayPd = { year: pd.year, month: pd.month, day: day.pbDay };
        if (isSameDay(dayPd, today)) cell.classList.add('today');
        if (isSameDay(dayPd, state.selectedDate)) cell.classList.add('selected');
        
        const events = getEventsForDate(dayPd);
        
        cell.innerHTML = `
          <span>${day.pbDay}</span>
          ${state.settings.showGregorian ? `<span class="day-gregorian">${day.gregorianDate.getDate()}/${day.gregorianDate.getMonth()+1}</span>` : ''}
          ${events.length > 0 ? '<span class="event-dot"></span>' : ''}
        `;
        
        cell.addEventListener('click', () => {
          state.selectedDate = { ...state.selectedDate, day: day.pbDay, gregorianDate: day.gregorianDate };
          render();
        });
        
        grid.appendChild(cell);
      });
    }

    function renderWeekView() {
      const pd = state.selectedDate;
      const baseDate = pd.gregorianDate || pbToGregorian(pd.year, pd.month, pd.day);
      const dayOfWeek = baseDate.getDay();
      const startOffset = state.settings.weekStartsOn === 1 
        ? (dayOfWeek === 0 ? -6 : 1 - dayOfWeek)
        : -dayOfWeek;
      
      const startDate = new Date(baseDate);
      startDate.setDate(startDate.getDate() + startOffset);
      
      const today = gregorianToPB(new Date());
      const grid = document.getElementById('week-grid');
      grid.innerHTML = '';
      
      for (let i = 0; i < 7; i++) {
        const date = new Date(startDate);
        date.setDate(date.getDate() + i);
        const dayPd = gregorianToPB(date);
        const events = getEventsForDate(dayPd);
        const isToday = isSameDay(dayPd, today);
        
        const row = document.createElement('div');
        row.className = `week-day-row ${isToday ? 'today' : ''}`;
        
        let dayDisplay = dayPd.day;
        if (dayPd.isEni) dayDisplay = '‚ú¶';
        if (dayPd.isBehti) dayDisplay = '‚òÖ';

        row.innerHTML = `
          <div class="week-day-date">
            <span class="week-day-name">${t(WEEKDAYS[date.getDay()])}</span>
            <span class="week-day-number">${dayDisplay}</span>
          </div>
          <div class="week-day-events">
            ${events.length === 0 ? '<span style="color:var(--color-text-tertiary)">‚Äî</span>' : 
              events.map(e => `<div class="event-card" onclick="openEventModal('${e.id}')"><div class="event-title">${e.title}</div></div>`).join('')}
          </div>
        `;
        row.addEventListener('click', (e) => {
          if (!e.target.closest('.event-card')) {
            state.selectedDate = dayPd;
            render();
          }
        });
        grid.appendChild(row);
      }
      
      const firstDay = gregorianToPB(startDate);
      const endDate = new Date(startDate);
      endDate.setDate(endDate.getDate() + 6);
      const lastDay = gregorianToPB(endDate);
      document.getElementById('week-title').textContent = `${firstDay.day || (firstDay.isEni?'‚ú¶':'‚òÖ')}-${lastDay.day || (lastDay.isEni?'‚ú¶':'‚òÖ')} ${getEntityName(firstDay.month)}`;
    }

    function renderDayView() {
      const pd = state.selectedDate;
      const events = getEventsForDate(pd);
      
      let dayText = pd.day;
      let monthText = '';
      
      if (pd.month === 0) { dayText = '‚ú¶'; monthText = '–ï–ù–ò'; }
      else if (pd.month === 13) { dayText = '‚òÖ'; monthText = '–ë–ï–•–¢–ò'; }
      else { monthText = t(MONTHS[pd.month - 1]); }
      
      document.getElementById('day-date').textContent = dayText;
      document.getElementById('day-month').textContent = monthText;
      
      const gd = pd.gregorianDate || pbToGregorian(pd.year, pd.month, pd.day);
      document.getElementById('day-gregorian').textContent = state.settings.showGregorian 
        ? `${gd.getDate()}/${gd.getMonth()+1}/${gd.getFullYear()}` : '';
      
      const container = document.getElementById('day-events');
      if (events.length === 0) {
        container.innerHTML = '<div class="empty-state">üìÖ –ù—è–º–∞ —Å—ä–±–∏—Ç–∏—è</div>';
      } else {
        container.innerHTML = events.map(e => `
          <div class="event-card" onclick="openEventModal('${e.id}')">
            ${e.hour !== undefined && e.hour !== '' ? `<div class="event-time">${String(e.hour).padStart(2,'0')}:${String(e.minute||0).padStart(2,'0')}</div>` : ''}
            <div>
              <div class="event-title">${e.title}</div>
              ${e.description ? `<div class="event-description">${e.description}</div>` : ''}
            </div>
          </div>
        `).join('');
      }
    }

    function renderYearView() {
      const pd = state.selectedDate;
      const today = gregorianToPB(new Date());
      
      document.getElementById('year-title').textContent = pd.year;
      
      const grid = document.getElementById('year-grid');
      grid.innerHTML = '';
      
      const structure = getYearStructure(pd.year);

      structure.forEach(entityId => {
        const card = document.createElement('div');
        const isCurrent = pd.month === entityId;
        card.className = `year-month-card ${isCurrent ? 'current' : ''}`;
        
        let title = getEntityName(entityId);
        
        let miniGrid = '';
        if (entityId === 0) { // Eni
            const isToday = isSameDay({ year: pd.year, month: 0, day: 1 }, today);
            miniGrid = `<div class="mini-day ${isToday ? 'today' : ''}" style="width:100%;text-align:center">‚ú¶</div>`;
        } else if (entityId === 13) { // Behti
            const isToday = isSameDay({ year: pd.year, month: 13, day: 1 }, today);
            miniGrid = `<div class="mini-day ${isToday ? 'today' : ''}" style="width:100%;text-align:center">‚òÖ</div>`;
        } else {
            const days = getMonthDays(pd.year, entityId);
            days.forEach(d => {
            const isToday = isSameDay({ year: pd.year, month: entityId, day: d.pbDay }, today);
            miniGrid += `<div class="mini-day ${isToday ? 'today' : ''}">${d.pbDay}</div>`;
            });
        }
        
        card.innerHTML = `
          <div class="year-month-title">${title}</div>
          <div class="year-month-mini-grid">${miniGrid}</div>
        `;
        
        card.addEventListener('click', () => {
          state.selectedDate = { ...state.selectedDate, month: entityId, day: 1 };
          state.currentView = 'month';
          render();
        });
        
        grid.appendChild(card);
      });
    }

    function render() {
      applyTheme();
      updateHeader();
      
      document.querySelectorAll('.view-switch-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === state.currentView);
      });
      
      document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
      document.getElementById(`view-${state.currentView}`).style.display = 'block';
      
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(`page-${state.currentPage}`).classList.add('active');
      
      document.querySelectorAll('.bottom-nav-item[data-page]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.page === state.currentPage);
      });
      
      document.getElementById('fab').style.display = state.currentPage === 'calendar' ? 'flex' : 'none';
      
      if (state.currentPage === 'calendar') {
        switch (state.currentView) {
          case 'month': renderMonthView(); break;
          case 'week': renderWeekView(); break;
          case 'day': renderDayView(); break;
          case 'year': renderYearView(); break;
        }
      }
      
      renderSettings();
    }

    function renderSettings() {
      document.getElementById('toggle-theme').classList.toggle('active', state.settings.theme === 'traditional');
      document.getElementById('theme-desc').textContent = state.settings.theme === 'traditional' ? '–¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∞' : '–ú–æ–¥–µ—Ä–Ω–∞';
      
      document.getElementById('toggle-mode').classList.toggle('active', state.settings.mode === 'dark');
      document.getElementById('mode-desc').textContent = state.settings.mode === 'light' ? '–°–≤–µ—Ç—ä–ª' : '–¢—ä–º–µ–Ω';
      
      document.getElementById('toggle-lang').classList.toggle('active', state.settings.lang === 'bg');
      document.getElementById('lang-desc').textContent = state.settings.lang === 'bg' ? '–ë—ä–ª–≥–∞—Ä—Å–∫–∏' : 'English';
      
      document.getElementById('toggle-terms').classList.toggle('active', state.settings.useProto);
      document.getElementById('terms-desc').textContent = state.settings.useProto ? '–ü—Ä–∞–±—ä–ª–≥–∞—Ä—Å–∫–∏' : '–°—ä–≤—Ä–µ–º–µ–Ω–Ω–∏';
      
      document.getElementById('toggle-week-start').classList.toggle('active', state.settings.weekStartsOn === 1);
      document.getElementById('week-start-desc').textContent = state.settings.weekStartsOn === 1 ? '–ü–æ–Ω–µ–¥–µ–ª–Ω–∏–∫' : '–ù–µ–¥–µ–ª—è';
      
      document.getElementById('toggle-gregorian').classList.toggle('active', state.settings.showGregorian);
    }

    // ===== TUTORIAL =====
    function renderTutorial() {
      const slide = TUTORIAL_SLIDES[state.tutorialSlide];
      document.getElementById('tutorial-icon').textContent = slide.icon;
      document.getElementById('tutorial-title').textContent = slide.title;
      document.getElementById('tutorial-desc').textContent = slide.desc;
      
      const dots = document.getElementById('tutorial-dots');
      dots.innerHTML = TUTORIAL_SLIDES.map((_, i) => 
        `<div class="tutorial-dot ${i === state.tutorialSlide ? 'active' : ''}"></div>`
      ).join('');
      
      document.getElementById('tutorial-next').textContent = 
        state.tutorialSlide === TUTORIAL_SLIDES.length - 1 ? '–ó–∞–ø–æ—á–Ω–∏' : '–ù–∞–ø—Ä–µ–¥';
    }

    function showTutorial() {
      state.tutorialSlide = 0;
      document.getElementById('tutorial').classList.remove('hidden');
      renderTutorial();
    }

    function closeTutorial() {
      document.getElementById('tutorial').classList.add('hidden');
      state.settings.tutorialDone = true;
      saveSettings();
    }

    // ===== EVENT MODAL =====
    function openEventModal(eventId = null) {
      const modal = document.getElementById('event-modal');
      modal.classList.remove('hidden');
      
      const pd = state.selectedDate;
      
      // Populate year dropdown
      const yearSelect = document.getElementById('event-year');
      yearSelect.innerHTML = '';
      for (let y = pd.year - 10; y <= pd.year + 50; y++) {
        const animal = getAnimalForYear(y);
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = `${y} ${t(animal)}`;
        if (y === pd.year) opt.selected = true;
        yearSelect.appendChild(opt);
      }
      
      // Populate month dropdown with Eni/Behti
      const monthSelect = document.getElementById('event-month');
      monthSelect.innerHTML = '';
      
      const structure = getYearStructure(pd.year);
      structure.forEach(mid => {
        const opt = document.createElement('option');
        opt.value = mid;
        opt.textContent = getEntityName(mid);
        if (mid === (pd.month)) opt.selected = true;
        monthSelect.appendChild(opt);
      });
      
      // Populate day dropdown
      updateDaySelect();
      
      // Populate hour dropdown
      const hourSelect = document.getElementById('event-hour');
      hourSelect.innerHTML = '<option value="">--</option>';
      for (let h = 0; h < 24; h++) {
        const opt = document.createElement('option');
        opt.value = h;
        opt.textContent = String(h).padStart(2, '0');
        hourSelect.appendChild(opt);
      }
      
      // Populate minute dropdown
      const minuteSelect = document.getElementById('event-minute');
      minuteSelect.innerHTML = '<option value="">--</option>';
      [0, 15, 30, 45].forEach(m => {
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = String(m).padStart(2, '0');
        minuteSelect.appendChild(opt);
      });
      
      if (eventId) {
        const event = state.events.find(e => e.id === eventId);
        if (event) {
          state.editingEvent = event;
          document.getElementById('modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π —Å—ä–±–∏—Ç–∏–µ';
          document.getElementById('event-title').value = event.title;
          document.getElementById('event-desc').value = event.description || '';
          document.getElementById('event-year').value = event.pbYear;
          document.getElementById('event-month').value = event.pbMonth;
          updateDaySelect();
          document.getElementById('event-day').value = event.pbDay;
          document.getElementById('event-hour').value = event.hour !== undefined ? event.hour : '';
          document.getElementById('event-minute').value = event.minute !== undefined ? event.minute : '';
          document.getElementById('event-recurrence').value = event.recurrence || 'none';
          document.getElementById('event-delete').style.display = 'block';
        }
      } else {
        state.editingEvent = null;
        document.getElementById('modal-title').textContent = '–î–æ–±–∞–≤–∏ —Å—ä–±–∏—Ç–∏–µ';
        document.getElementById('event-title').value = '';
        document.getElementById('event-desc').value = '';
        document.getElementById('event-day').value = pd.day || 1;
        document.getElementById('event-hour').value = '';
        document.getElementById('event-minute').value = '';
        document.getElementById('event-recurrence').value = 'none';
        document.getElementById('event-delete').style.display = 'none';
      }
    }
    
    function updateDaySelect() {
      const monthVal = parseInt(document.getElementById('event-month').value);
      const pbYear = parseInt(document.getElementById('event-year').value);
      const daySelect = document.getElementById('event-day');
      const currentDay = parseInt(daySelect.value) || 1;
      
      let maxDays = 1;
      if (monthVal === 0) maxDays = 1; // Eni
      else if (monthVal === 13) maxDays = 1; // Behti
      else maxDays = MONTHS[monthVal - 1].days;

      daySelect.innerHTML = '';
      for (let d = 1; d <= maxDays; d++) {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        daySelect.appendChild(opt);
      }
      daySelect.value = Math.min(currentDay, maxDays);
    }

    function closeEventModal() {
      document.getElementById('event-modal').classList.add('hidden');
      state.editingEvent = null;
    }

    async function saveEventFromModal() {
      const title = document.getElementById('event-title').value.trim();
      if (!title) return;
      
      const pbYear = parseInt(document.getElementById('event-year').value);
      const pbMonth = parseInt(document.getElementById('event-month').value);
      const pbDay = parseInt(document.getElementById('event-day').value);
      const hour = document.getElementById('event-hour').value;
      const minute = document.getElementById('event-minute').value;
      
      const event = {
        id: state.editingEvent?.id || Date.now().toString(),
        title,
        description: document.getElementById('event-desc').value.trim(),
        pbYear,
        pbMonth,
        pbDay,
        hour: hour !== '' ? parseInt(hour) : undefined,
        minute: minute !== '' ? parseInt(minute) : undefined,
        recurrence: document.getElementById('event-recurrence').value,
        gregorianDate: pbToGregorian(pbYear, pbMonth, pbDay).toISOString(),
      };
      
      await saveEvent(event);
      closeEventModal();
      render();
    }

    // ===== EXPORT/IMPORT =====
    function exportICS() {
      const lines = ['BEGIN:VCALENDAR', 'VERSION:2.0', 'PRODID:-//Imennik//Proto-Bulgarian Calendar//EN'];
      
      state.events.forEach(e => {
        const d = new Date(e.gregorianDate);
        const dateStr = d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        lines.push('BEGIN:VEVENT');
        lines.push(`UID:${e.id}@imennik`);
        lines.push(`DTSTAMP:${dateStr}`);
        lines.push(`DTSTART:${dateStr}`);
        lines.push(`SUMMARY:${e.title}`);
        if (e.description) lines.push(`DESCRIPTION:${e.description}`);
        lines.push('END:VEVENT');
      });
      
      lines.push('END:VCALENDAR');
      
      const blob = new Blob([lines.join('\r\n')], { type: 'text/calendar' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'imennik-calendar.ics';
      a.click();
      URL.revokeObjectURL(url);
    }

    async function importICS(file) {
      const text = await file.text();
      const lines = text.split(/\r?\n/);
      let currentEvent = null;
      let count = 0;
      
      for (const line of lines) {
        if (line === 'BEGIN:VEVENT') {
          currentEvent = {};
        } else if (line === 'END:VEVENT' && currentEvent) {
          if (currentEvent.title && currentEvent.date) {
            const pd = gregorianToPB(currentEvent.date);
            await saveEvent({
              id: Date.now().toString() + count,
              title: currentEvent.title,
              description: currentEvent.description || '',
              pbYear: pd.year,
              pbMonth: pd.month,
              pbDay: pd.day,
              gregorianDate: currentEvent.date.toISOString(),
            });
            count++;
          }
          currentEvent = null;
        } else if (currentEvent) {
          if (line.startsWith('SUMMARY:')) currentEvent.title = line.substring(8);
          if (line.startsWith('DESCRIPTION:')) currentEvent.description = line.substring(12);
          if (line.startsWith('DTSTART:')) {
            const ds = line.substring(8);
            const year = parseInt(ds.substring(0, 4));
            const month = parseInt(ds.substring(4, 6)) - 1;
            const day = parseInt(ds.substring(6, 8));
            currentEvent.date = new Date(year, month, day);
          }
        }
      }
      
      await loadEvents();
      render();
      alert(`–ò–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω–∏ ${count} —Å—ä–±–∏—Ç–∏—è`);
    }

    // ===== EVENT LISTENERS =====
    function setupEventListeners() {
      // View switcher
      document.querySelectorAll('.view-switch-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          state.currentView = btn.dataset.view;
          render();
        });
      });
      
      // Bottom nav
      document.querySelectorAll('.bottom-nav-item[data-page]').forEach(btn => {
        btn.addEventListener('click', () => {
          state.currentPage = btn.dataset.page;
          render();
        });
      });
      
      // Today button
      document.getElementById('today-btn').addEventListener('click', () => {
        state.selectedDate = gregorianToPB(new Date());
        state.currentPage = 'calendar';
        render();
      });
      
      // Navigation
      document.getElementById('prev-month').addEventListener('click', () => navigateMonth(-1));
      document.getElementById('next-month').addEventListener('click', () => navigateMonth(1));
      document.getElementById('prev-week').addEventListener('click', () => navigateWeek(-1));
      document.getElementById('next-week').addEventListener('click', () => navigateWeek(1));
      document.getElementById('prev-day').addEventListener('click', () => navigateDay(-1));
      document.getElementById('next-day').addEventListener('click', () => navigateDay(1));
      document.getElementById('prev-year').addEventListener('click', () => navigateYear(-1));
      document.getElementById('next-year').addEventListener('click', () => navigateYear(1));
      
      // FAB
      document.getElementById('fab').addEventListener('click', () => openEventModal());
      
      // Quick add
      document.getElementById('quick-add-btn').addEventListener('click', quickAdd);
      document.getElementById('quick-add-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') quickAdd();
      });
      
      // Event modal
      document.getElementById('modal-close').addEventListener('click', closeEventModal);
      document.getElementById('event-cancel').addEventListener('click', closeEventModal);
      document.getElementById('event-save').addEventListener('click', saveEventFromModal);
      document.getElementById('event-delete').addEventListener('click', async () => {
        if (state.editingEvent && confirm('–ò–∑—Ç—Ä–∏–π —Å—ä–±–∏—Ç–∏–µ—Ç–æ?')) {
          await deleteEvent(state.editingEvent.id);
          closeEventModal();
          render();
        }
      });
      document.getElementById('event-modal').addEventListener('click', (e) => {
        if (e.target.id === 'event-modal') closeEventModal();
      });
      document.getElementById('event-month').addEventListener('change', updateDaySelect);
      document.getElementById('event-year').addEventListener('change', () => {
         // Re-populate month to update for leap year (Behti availability)
         const year = parseInt(document.getElementById('event-year').value);
         const monthSelect = document.getElementById('event-month');
         const currentMonth = parseInt(monthSelect.value);
         monthSelect.innerHTML = '';
         getYearStructure(year).forEach(mid => {
            const opt = document.createElement('option');
            opt.value = mid;
            opt.textContent = getEntityName(mid);
            if (mid === currentMonth) opt.selected = true;
            monthSelect.appendChild(opt);
         });
         updateDaySelect();
      });

      
      // Settings toggles
      document.getElementById('toggle-theme').addEventListener('click', () => {
        state.settings.theme = state.settings.theme === 'traditional' ? 'modern' : 'traditional';
        saveSettings();
        render();
      });
      document.getElementById('toggle-mode').addEventListener('click', () => {
        state.settings.mode = state.settings.mode === 'light' ? 'dark' : 'light';
        saveSettings();
        render();
      });
      document.getElementById('toggle-lang').addEventListener('click', () => {
        state.settings.lang = state.settings.lang === 'bg' ? 'en' : 'bg';
        saveSettings();
        render();
      });
      document.getElementById('toggle-terms').addEventListener('click', () => {
        state.settings.useProto = !state.settings.useProto;
        saveSettings();
        render();
      });
      document.getElementById('toggle-week-start').addEventListener('click', () => {
        state.settings.weekStartsOn = state.settings.weekStartsOn === 1 ? 0 : 1;
        saveSettings();
        render();
      });
      document.getElementById('toggle-gregorian').addEventListener('click', () => {
        state.settings.showGregorian = !state.settings.showGregorian;
        saveSettings();
        render();
      });
      
      // Tutorial
      document.getElementById('tutorial-btn').addEventListener('click', showTutorial);
      document.getElementById('tutorial-skip').addEventListener('click', closeTutorial);
      document.getElementById('tutorial-next').addEventListener('click', () => {
        if (state.tutorialSlide < TUTORIAL_SLIDES.length - 1) {
          state.tutorialSlide++;
          renderTutorial();
        } else {
          closeTutorial();
        }
      });
      
      // Export/Import
      document.getElementById('export-btn').addEventListener('click', exportICS);
      document.getElementById('import-btn').addEventListener('click', () => {
        document.getElementById('import-file').click();
      });
      document.getElementById('import-file').addEventListener('change', (e) => {
        if (e.target.files[0]) importICS(e.target.files[0]);
      });
    }

    function navigateMonth(dir) {
      const struct = getYearStructure(state.selectedDate.year);
      const currentIdx = struct.indexOf(state.selectedDate.month);
      
      let newIdx = currentIdx + dir;
      let newYear = state.selectedDate.year;
      
      if (newIdx >= struct.length) {
        newYear++;
        const nextStruct = getYearStructure(newYear);
        newIdx = 0; // Go to Eni of next year
        // Update selectedDate to use new struct
        state.selectedDate = {
            ...state.selectedDate,
            year: newYear,
            month: nextStruct[newIdx],
            day: 1
        };
      } else if (newIdx < 0) {
        newYear--;
        const prevStruct = getYearStructure(newYear);
        newIdx = prevStruct.length - 1; // Go to last month of prev year
        state.selectedDate = {
            ...state.selectedDate,
            year: newYear,
            month: prevStruct[newIdx],
            day: 1
        };
      } else {
        // Same year
        state.selectedDate = {
            ...state.selectedDate,
            month: struct[newIdx],
            day: 1
        };
      }
      
      state.selectedDate.gregorianDate = pbToGregorian(state.selectedDate.year, state.selectedDate.month, 1);
      render();
    }

    function navigateWeek(dir) {
      const gd = state.selectedDate.gregorianDate || pbToGregorian(state.selectedDate.year, state.selectedDate.month, state.selectedDate.day);
      const newDate = new Date(gd);
      newDate.setDate(newDate.getDate() + dir * 7);
      state.selectedDate = gregorianToPB(newDate);
      render();
    }

    function navigateDay(dir) {
      const gd = state.selectedDate.gregorianDate || pbToGregorian(state.selectedDate.year, state.selectedDate.month, state.selectedDate.day);
      const newDate = new Date(gd);
      newDate.setDate(newDate.getDate() + dir);
      state.selectedDate = gregorianToPB(newDate);
      render();
    }

    function navigateYear(dir) {
      state.selectedDate = { ...state.selectedDate, year: state.selectedDate.year + dir };
      // Check if current month exists in new year (Behti check)
      const struct = getYearStructure(state.selectedDate.year);
      if (!struct.includes(state.selectedDate.month)) {
          // If was Behti and new year has no Behti, go to Month 7
          state.selectedDate.month = 7; 
      }
      
      state.selectedDate.gregorianDate = pbToGregorian(state.selectedDate.year, state.selectedDate.month, state.selectedDate.day || 1);
      render();
    }

    async function quickAdd() {
      const input = document.getElementById('quick-add-input');
      const title = input.value.trim();
      if (!title) return;
      
      const pd = state.selectedDate;
      await saveEvent({
        id: Date.now().toString(),
        title,
        description: '',
        pbYear: pd.year,
        pbMonth: pd.month,
        pbDay: pd.day || 1,
        gregorianDate: (pd.gregorianDate || pbToGregorian(pd.year, pd.month, pd.day || 1)).toISOString(),
      });
      
      input.value = '';
      render();
    }

    // ===== INIT =====
    async function init() {
      try {
        await initDB();
        await loadSettings();
        await loadEvents();
        
        state.selectedDate = gregorianToPB(new Date());
        
        setupEventListeners();
        render();
        
        if (!state.settings.tutorialDone) {
          showTutorial();
        }
      } catch (error) {
        console.error('Failed to initialize:', error);
      }
    }

    // Make openEventModal global for onclick handlers
    window.openEventModal = openEventModal;

    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW registration failed:', err));
    }

    // Start the app
    init();
  </script>
</body>
</html>
